<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Reagent-ology</title>
<style>
    body { 
        font-family: Arial, sans-serif; 
        margin: 0; 
        padding: 0;
        background-image: url('lab.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        color: white;
    }
    header {
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 10px 20px; 
        background-color: rgba(144,178,187,0.95);
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(4px);
    }
    header h1 { margin: 0; font-size: 1.4rem; }
    #login-form input { margin-right: 5px; padding:5px; border-radius:3px; border:1px solid #ccc; }
    #login-form button { padding:5px 10px; border:none; border-radius:3px; background-color:#1b8cae; color:white; cursor:pointer; }
    #login-form button:hover { background-color:#147d99; }

    nav {
        display: flex; 
        justify-content: flex-end; 
        background-color: rgba(144,178,187,0.95); 
        padding: 8px 20px;
    }
    nav button {
        padding: 6px 12px;
        margin-left: 8px;
        background-color: transparent;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-weight: 600;
    }
    nav button:hover { background-color: rgba(0,86,179,0.2); }

    .page { display: none; margin: 20px; background-color: rgba(0,0,0,0.45); padding: 20px; border-radius: 8px; }
    #about {
        display: block;
        max-height: 700px;
        overflow-y: auto;
        padding: 20px;
        background: rgba(255, 255, 255, 0.12);
        border-radius: 10px;
    }
    #about::-webkit-scrollbar { width: 8px; }
    #about::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.18); border-radius: 4px; }
    .about-section {
        margin-bottom: 20px;
        padding: 16px;
        background: rgba(0, 0, 0, 0.35);
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        transition: transform 0.12s;
    }
    .about-section:hover { transform: translateY(-4px); }
    .about-section h3 { margin-top: 0; color: #ffffff; font-size: 1.15em; }
    .about-section p, .about-section li { line-height: 1.6; color: #ecf0f1; }
    .about-section ul { padding-left: 20px; }
    #about h2 { color: #ffffff; }

    li { 
        margin-bottom: 10px; 
        padding: 10px;
        background-color: rgba(79, 128, 147, 0.72);
        border-radius: 6px;
        list-style:none;
    }
    input, button.action-btn, select { margin-right:5px; padding:6px; border-radius:4px; border:1px solid #ccc; }
    button.action-btn { cursor:pointer; border:none; color:white; padding:6px 8px; margin-left:6px; }
    button.action-btn.edit { background-color:#ffc107; color:black; }
    button.action-btn.edit:hover { background-color:#e0a800; }
    button.action-btn.delete { background-color:#dc3545; }
    button.action-btn.delete:hover { background-color:#c82333; }
    button.action-btn.use { background-color:#28a745; }
    button.action-btn.use:hover { background-color:#218838; }
    button.action-btn.discard { background-color:#6c757d; }
    button.action-btn.discard:hover { background-color:#5a6268; }
    button.action-btn.scale { background-color:#17a2b8; }
    button.action-btn.scale:hover { background-color:#138496; }

    .controls { margin-bottom: 12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .small { padding:4px 8px; font-size:0.9rem; }

    #chemical-detail { padding: 10px; background: rgba(0,0,0,0.4); border-radius:8px; }
    .topbar-right { display:flex; gap:8px; align-items:center; }
    .danger-note { color:#ffdddd; background: rgba(220,53,69,0.12); padding:8px; border-radius:6px; margin-top:8px; }
    .meta { font-size:0.9rem; color:#e6f1f5; margin-top:8px; }

    /* App-branded modal/alert */
    .app-modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.55); display:flex; align-items:center; justify-content:center; z-index:2000; }
    .app-modal { width:min(90%,520px); background:#152833; color:#e8f6ff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.4); overflow:hidden; }
    .app-modal header { background:#1b8cae; padding:12px 16px; font-weight:700; }
    .app-modal .body { padding:16px; white-space:pre-wrap; line-height:1.5; }
    .app-modal footer { padding:12px 16px; display:flex; gap:8px; justify-content:flex-end; background:rgba(255,255,255,0.03); }
    .app-btn { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; }
    .app-btn.primary { background:#1b8cae; color:#fff; }
    .app-btn.ghost { background:transparent; color:#cfe9f3; border:1px solid rgba(255,255,255,0.2); }
    .app-toast { position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:rgba(0,0,0,0.78); color:#fff; padding:10px 14px; border-radius:8px; z-index:2100; max-width:90%; text-align:center; }
</style>
</head>
<body>
    <!-- í—¤ë” -->
    <header>
        <div id="logo"><h1>Reagent-ology</h1></div>
        <div class="topbar-right">
            <span id="whoami" style="font-weight:600;"></span>
            <button id="logoutBtn" style="display:none;" onclick="logout()" class="small">Logout</button>
        </div>
    </header>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-page" style="padding:20px;">
        <h1>Reagent-ology Login</h1>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <button onclick="signup()">Sign Up</button>
        <div class="danger-note">
            <strong>ì£¼ì˜:</strong> í˜„ì¬ëŠ” ë¡œì»¬ ë°ëª¨ ëª¨ë“œì…ë‹ˆë‹¤. ì‹¤ì œ ìš´ì˜ ì‹œ ì„œë²„ ê¸°ë°˜ ì¸ì¦(í•´ì‹œ+HTTPS)ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”.
        </div>
    </div>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <div id="main-page" style="display:none; padding:20px;">
        <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav>
            <button onclick="navigateTo('about')">ê¸°ì—… ì†Œê°œ</button>
            <button onclick="navigateTo('add')">ì‹œì•½ ë“±ë¡</button>
            <button onclick="navigateTo('numbers')">ë²ˆí˜¸ ìƒì„±</button>
            <button onclick="navigateTo('discard')">ì‹œì•½ íê¸°</button>
            <button onclick="navigateTo('inventory')">ì—°êµ¬ì‹¤ ë³´ìœ  ë¬¼ì§ˆ</button>
            <button onclick="navigateTo('usage')">ì‹œì•½ ì‚¬ìš© í˜„í™©</button>
            <!-- ë¶ˆí•„ìš” íƒ­ ìˆ¨ê¹€: ì €ìš¸ CSV ì—…ë¡œë“œ / ìë™ì™„ì„± DB -->
        </nav>

        <!-- ê° í˜ì´ì§€ ì˜ì—­ -->
        <div id="about" class="page">
            <h2>Reagent-ology ì†Œê°œ</h2>
            <div class="about-section">
                <h3>íšŒì‚¬ ë¹„ì „</h3>
                <p>ìš°ë¦¬ëŠ” ì—°êµ¬ì‹¤ì˜ ì•ˆì „í•˜ê³  íš¨ìœ¨ì ì¸ ì‹œì•½ ê´€ë¦¬ë¥¼ ìœ„í•´ ìµœì²¨ë‹¨ ë””ì§€í„¸ ì†”ë£¨ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
            </div>
            <div class="about-section">
                <h3>ì£¼ìš” ê¸°ëŠ¥</h3>
                <ul>
                    <li>ì „ ì£¼ê¸° ì‹œì•½ ê´€ë¦¬ (ë“±ë¡, ì‚¬ìš©, ì´ë™, íê¸°)</li>
                    <li>GHS ê¸°ë°˜ ë¶„ë¥˜ ë° ê²½ê³  ì‹œìŠ¤í…œ</li>
                    <li>ë²•ì  ê·œì œ ì¤€ìˆ˜ ì§€ì›</li>
                    <li>NFC ìŠ¤í‹°ì»¤ ê¸°ë°˜ ì‹œì•½ íƒœê¹…</li>
                    <li>ì‚¬ìš©ëŸ‰, íê¸°ëŸ‰, ë³´ê´€ í˜„í™© ìë™ ê¸°ë¡</li>
                </ul>
            </div>
            <div class="about-section">
                <h3>ì—°êµ¬ì‹¤ ë„ì… íš¨ê³¼</h3>
                <p>ì‚¬ìš©ìëŠ” ì§ê´€ì ì¸ ëŒ€ì‹œë³´ë“œë¡œ ì‹¤í—˜ì‹¤ ìš´ì˜ ìƒí™©ì„ í•œëˆˆì— í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©°, ì•ˆì „ ì‚¬ê³ ë¥¼ ì˜ˆë°©í•˜ê³  íš¨ìœ¨ì ì¸ ì‹œì•½ êµ¬ë§¤ ê³„íšì„ ìˆ˜ë¦½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <div id="add" class="page">
            <h2>ì‹œì•½ ë“±ë¡ / ìˆ˜ì •</h2>
            <div class="controls">
                <input type="hidden" id="edit-id">
                <input type="text" id="name" placeholder="Name" list="chemical-suggestions" autocomplete="off">
                <datalist id="chemical-suggestions"></datalist>
                <input type="text" id="formula" placeholder="Formula">
                <input type="text" id="cas" placeholder="CAS ë²ˆí˜¸">
                <input type="text" id="location" placeholder="Location" list="location-suggestions" autocomplete="off">
                <datalist id="location-suggestions"></datalist>
                <input type="text" id="storage" placeholder="ë³´ê´€ ì¡°ê±´">
                <span style="color:#fff;opacity:.9;">ìœ í†µê¸°í•œ</span>
                <input type="date" id="expiry" placeholder="YYYY-MM-DD">
                <input type="text" id="hazard" placeholder="GHS ë¶„ë¥˜ (ì½¤ë§ˆë¡œ êµ¬ë¶„)">
                <input type="text" id="disposal" placeholder="íê¸° ë°©ë²•">
                <input type="number" step="0.01" id="quantity" placeholder="Quantity (ml/g)">
                <input type="number" step="0.0001" id="density" placeholder="Density (g/mL)">
                <input type="text" id="nfcTag" placeholder="NFC Tag UID">
                <select id="propertyTag" title="êµ¬ë¶„">
                    <option value="">êµ¬ë¶„</option>
                    <option value="ê¸ˆì†">ê¸ˆì†</option>
                    <option value="ë¹„ê¸ˆì†">ë¹„ê¸ˆì†</option>
                    <option value="ê¸ˆì†ì‚°í™”ë¬¼">ê¸ˆì†ì‚°í™”ë¬¼</option>
                    <option value="ì‚°">ì‚°</option>
                    <option value="ì—¼ê¸°">ì—¼ê¸°</option>
                    <option value="ì‚°í™”ì œ">ì‚°í™”ì œ</option>
                    <option value="í™˜ì›ì œ">í™˜ì›ì œ</option>
                    <option value="í• ë¡œê²í™”ë¬¼">í• ë¡œê²í™”ë¬¼</option>
                    <option value="ìš©ë§¤">ìš©ë§¤</option>
                    <option value="ì‹œì•½">ì‹œì•½</option>
                </select>
                <select id="state">
                <option value="liquid">liquid</option>
                <option value="solid">solid</option>
                </select>

                <button onclick="saveChemical()" class="action-btn small">Save</button>
                <button onclick="openAddScaleModal()" class="small">ì €ìš¸ì—ì„œ ì½ê¸°</button>
                <button onclick="createDummyNextQuick()" class="small">ë”ë¯¸ë§Œ ìƒì„±</button>
                <button onclick="openNextAdd()" class="small">ë‹¤ìŒ ë²ˆí˜¸ë¡œ ë“±ë¡ ì´ë™</button>
                <button onclick="resetForm()" class="small">Clear</button>
            </div>
            <div id="form-note" class="meta">í•„ìˆ˜ ì…ë ¥ ì—†ìŒ. í•„ìš”í•œ í•­ëª©ë§Œ ì…ë ¥í•´ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ê¶Œì¥: Formula, Location, Quantity; ë°€ë„(g/mL)ë¥¼ ì…ë ¥í•˜ë©´ ë¬´ê²Œ ì¸¡ì • ì‹œ mL í™˜ì‚°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.)</div>
        </div>

        <div id="discard" class="page">
            <h2>ì‹œì•½ íê¸°</h2>
            <div class="controls">
                <button onclick="autoDiscardReport()" class="small">íê¸° ë¦¬í¬íŠ¸ ìƒì„± (CSV)</button>
            </div>
            <ul id="discard-list"></ul>
        </div>

        <div id="inventory" class="page">
            <h2>ì—°êµ¬ì‹¤ ë³´ìœ  ë¬¼ì§ˆ</h2>
            <div class="controls">
                <input type="text" id="search" placeholder="ê²€ìƒ‰: ì´ë¦„/ê³µì‹/CAS..." oninput="renderList()">
                <select id="filterGHS" onchange="renderList()">
                    <option value="">--GHS ë¶„ë¥˜--</option>
                </select>
                <select id="filterProp" onchange="renderList()">
                    <option value="">--êµ¬ë¶„ í•„í„°--</option>
                    <option>ê¸ˆì†</option>
                    <option>ë¹„ê¸ˆì†</option>
                    <option>ê¸ˆì†ì‚°í™”ë¬¼</option>
                    <option>ì‚°</option>
                    <option>ì—¼ê¸°</option>
                    <option>ì‚°í™”ì œ</option>
                    <option>í™˜ì›ì œ</option>
                    <option>í• ë¡œê²í™”ë¬¼</option>
                    <option>ìš©ë§¤</option>
                </select>
                <select id="filterLocation" onchange="renderList()"><option value="">--ìœ„ì¹˜--</option></select>
                <select id="filterStorage" onchange="renderList()"><option value="">--ë³´ê´€ ì¡°ê±´--</option></select>
                <select id="filterExpiry" onchange="renderList()"><option value="">--ìœ í†µê¸°í•œ ìƒíƒœ--</option><option value="expired">ìœ í†µê¸°í•œ ì§€ë‚¨</option><option value="soon">ìœ í†µê¸°í•œ ì„ë°•(10ì¼)</option></select>
                <select id="filterDisposal" onchange="renderList()"><option value="">--íê¸° ë°©ë²•--</option></select>
                <select id="filterState" onchange="renderList()"><option value="">--ìƒíƒœ--</option></select>
                <select id="sortBy" onchange="renderList()">
                    <option value="name">ì´ë¦„</option>
                    <option value="quantity">ìˆ˜ëŸ‰</option>
                    <option value="prop">ì„±ì§ˆ</option>
                    <option value="expiry">ìœ í†µê¸°í•œ</option>
                </select>
                <button onclick="(async()=>{await refreshReagents(); rebuildInventoryFilters(); renderList(); appToast('ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');})()" class="small">ì„œë²„ ìƒˆë¡œê³ ì¹¨</button>
                <button onclick="exportCSV()" class="small">CSV ë‚´ë³´ë‚´ê¸°</button>
                <button onclick="exportXLSX()" class="small">XLSX ë‚´ë³´ë‚´ê¸°</button>
            </div>
            <ul id="chemical-list"></ul>
        </div>

        <div id="auto-db" class="page">
            <h2>ìë™ì™„ì„± DB ê´€ë¦¬ (ë¡œì»¬ CSV)</h2>
            <div class="controls">
                <input type="text" id="auto-name" placeholder="Name">
                <input type="text" id="auto-formula" placeholder="Formula">
                <input type="text" id="auto-synonyms" placeholder="Synonyms (ì„¸ë¯¸ì½œë¡  ; êµ¬ë¶„)">
                <button class="small" onclick="addLocalAutoItem()">ì¶”ê°€</button>
            </div>
            <ul id="auto-db-list"></ul>
        </div>

        <div id="usage" class="page">
            <h2>ì‹œì•½ ì‚¬ìš© í˜„í™©</h2>
            <div class="controls">
                <button onclick="resetUsageStats()" class="small">ì‚¬ìš© í†µê³„ ë¦¬ì…‹</button>
            </div>
            <ul id="usage-list"></ul>
        </div>

        <div id="numbers" class="page">
            <h2>ë²ˆí˜¸ ìƒì„±(ë”ë¯¸/ë“±ë¡ ì´ë™)</h2>
            <div class="about-section">
                <p>ìŠ¤í‹°ì»¤/UIDë¥¼ ìˆ«ìë§Œìœ¼ë¡œ ìš´ìš©í•  ë•Œ, ë‹¤ìŒ ë²ˆí˜¸ë¥¼ ìë™ìœ¼ë¡œ ì‚°ì¶œí•´ ë“±ë¡ í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ê±°ë‚˜ ë”ë¯¸ë¥¼ ë¨¼ì € ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:8px;">
                    <div>í˜„ì¬ ë§ˆì§€ë§‰ ë²ˆí˜¸: <strong id="current-max-number">-</strong></div>
                    <div>ë‹¤ìŒ ë²ˆí˜¸: <strong id="next-number">-</strong></div>
                    <button class="small" onclick="createDummyNextQuick()">ë‹¤ìŒ ë²ˆí˜¸ ë”ë¯¸ë§Œ ìƒì„±</button>
                    <button class="small" onclick="createDummyNextAndEdit()">ë‹¤ìŒ ë²ˆí˜¸ ë”ë¯¸ ìƒì„± í›„ ìˆ˜ì • (#/add/N)</button>
                    <div style="display:flex; gap:6px; align-items:center;">
                        <input type="number" id="bulk-dummy-count" value="10" min="1" step="1" style="width:80px; padding:6px; border-radius:4px;"/>
                        <button class="small" onclick="createBulkDummiesFromInput()">ëŒ€ëŸ‰ ë”ë¯¸ ìƒì„±</button>
                    </div>
                    <button class="small" onclick="refreshNumbersPage()">ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
        </div>

        <div id="scale-csv" class="page">
            <h2>ì €ìš¸ ì¸¡ì •ê°’ CSV ì—…ë¡œë“œ</h2>
            
            <div class="about-section">
                <h3>ğŸ“¤ CSV íŒŒì¼ ì—…ë¡œë“œ</h3>
                <p>ì €ìš¸ì—ì„œ ì¸¡ì •í•œ ë¬´ê²Œ ë°ì´í„°ë¥¼ CSV íŒŒì¼ë¡œ ì—…ë¡œë“œí•˜ì—¬ ì‹œì•½ ìˆ˜ëŸ‰ì„ ì¼ê´„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.</p>
                
                <div style="margin-top:12px;">
                    <input type="file" id="csvFileInput" accept=".csv" style="padding:8px;">
                    <button onclick="uploadScaleCsvFile()" class="action-btn" style="background-color:#17a2b8; margin-left:8px;">
                        ì—…ë¡œë“œ ë° ì²˜ë¦¬
                    </button>
                </div>
                
                <div id="csv-upload-result" style="margin-top:12px; padding:10px; background:rgba(0,0,0,0.3); border-radius:4px; display:none;">
                    <h4>ì²˜ë¦¬ ê²°ê³¼</h4>
                    <div id="csv-result-content"></div>
                </div>
            </div>

            <div class="about-section">
                <h3>ğŸ“‹ CSV íŒŒì¼ í˜•ì‹</h3>
                <p>ë‹¤ìŒ í˜•ì‹ì˜ CSV íŒŒì¼ì„ ì‚¬ìš©í•˜ì„¸ìš” (UTF-8 ì¸ì½”ë”©):</p>
                <pre style="background:rgba(0,0,0,0.4); padding:12px; border-radius:4px; overflow-x:auto;">
nfc_tag_uid,reagent_id,reagent_name,measured_weight,timestamp,note,operator
NFC-ACE-001,1,ì•„ì„¸í†¤,485.5,2025-11-05T14:30:00,ì •ê¸°ì¸¡ì •,ê¹€ì² ìˆ˜
NFC-ETH-001,2,Ethanol,920.3,2025-11-05T14:31:00,ì‚¬ìš©í›„ì¸¡ì •,ê¹€ì² ìˆ˜
,3,Methanol,275.8,2025-11-05T14:32:00,,ì´ì˜í¬</pre>
                
                <h4>í•„ë“œ ì„¤ëª…:</h4>
                <ul style="list-style:disc; padding-left:20px;">
                    <li><strong>nfc_tag_uid, reagent_id, reagent_name</strong>: ìµœì†Œ í•˜ë‚˜ í•„ìˆ˜ (ì‹œì•½ ì‹ë³„ìš©)</li>
                    <li><strong>measured_weight</strong>: í•„ìˆ˜, ì¸¡ì •ëœ ë¬´ê²Œ (ê·¸ë¨)</li>
                    <li><strong>timestamp</strong>: ì„ íƒ, ì¸¡ì • ì‹œê° (ISO 8601 í˜•ì‹)</li>
                    <li><strong>note</strong>: ì„ íƒ, ë©”ëª¨</li>
                    <li><strong>operator</strong>: ì„ íƒ, ì¸¡ì •ì ì´ë¦„</li>
                </ul>
                
                <button onclick="downloadSampleCsv()" class="small" style="margin-top:8px;">
                    ìƒ˜í”Œ CSV ë‹¤ìš´ë¡œë“œ
                </button>
            </div>

            <div class="about-section">
                <h3>ğŸ’¾ ì‹¤ì‹œê°„ ì¸¡ì •ê°’ ì €ì¥</h3>
                <p>ì €ìš¸ë¡œ ì¸¡ì •í•œ ê°’ì„ CSV íŒŒì¼ì— ì¦‰ì‹œ ì €ì¥í•©ë‹ˆë‹¤ (DBì—ëŠ” ë°˜ì˜í•˜ì§€ ì•ŠìŒ).</p>
                
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
                    <input type="text" id="quick-nfc" placeholder="NFC Tag UID" style="flex:1; min-width:150px;">
                    <input type="number" id="quick-weight" placeholder="ë¬´ê²Œ (g)" step="0.01" style="flex:1; min-width:120px;">
                    <input type="text" id="quick-note" placeholder="ë©”ëª¨" style="flex:1; min-width:150px;">
                    <input type="text" id="quick-operator" placeholder="ì¸¡ì •ì" style="flex:1; min-width:100px;">
                    <button onclick="saveQuickMeasurement()" class="action-btn" style="background-color:#28a745;">
                        CSVì— ì €ì¥
                    </button>
                </div>
                
                <p style="margin-top:8px; font-size:0.9em; opacity:0.8;">
                    ì €ì¥ëœ ì¸¡ì •ê°’ì€ data/scale_measurements.csv íŒŒì¼ì— ê¸°ë¡ë˜ë©°, ìœ„ì˜ ì—…ë¡œë“œ ê¸°ëŠ¥ìœ¼ë¡œ DBì— ë°˜ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>
        </div>

        <!-- ìƒì„¸ í˜ì´ì§€ -->
        <div id="detail-page" class="page">
            <button onclick="showPage('inventory')" class="small">â† ë’¤ë¡œ</button>
            <div id="chemical-detail"></div>
        </div>
    </div>

<script>
// API BaseëŠ” ì ‘ì†í•œ í˜¸ìŠ¤íŠ¸(PCì˜ ë‚´ë¶€ IP ë“±)ì— ë§ì¶° ë™ì‘í•˜ë„ë¡ ë™ì ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
const API_BASE = (location && location.origin && location.origin.startsWith('http'))
    ? `${location.origin}/api`
    : 'http://127.0.0.1:8000/api';
const USER_KEY = 'reagentology_users_v1';
const LOGGED_KEY = 'reagentology_loggedin';
const SEED_KEY = 'reagentology_seeded';
const STICKER_HOST_KEY = 'reagentology_sticker_host';

const DEFAULT_CHEMS = [
    {
        name: 'Acetone',
        formula: 'C3H6O',
        cas: '67-64-1',
        ghs: ['Flammable'],
        location: 'Shelf A',
        storage: 'RT',
        quantity: 500,
        density: 0.7845,
        nfc_tag_uid: 'NFC-ACE-001',
        
        disposal: 'í™”í•™íê¸°ë¬¼',
    },
    {
        name: 'Ethanol',
        formula: 'C2H6O',
        cas: '64-17-5',
        ghs: ['Flammable'],
        location: 'Shelf B',
        storage: 'RT',
        quantity: 1000,
        density: 0.789,
        nfc_tag_uid: 'NFC-ETH-001',
        
        disposal: 'í™”í•™íê¸°ë¬¼',
    },
    {
        name: 'Methanol',
        formula: 'CH3OH',
        cas: '67-56-1',
        ghs: ['Flammable', 'Toxic'],
        location: 'Shelf A',
        storage: 'RT',
        quantity: 300,
        density: 0.792,
        nfc_tag_uid: 'NFC-MEOH-001',
        
        disposal: 'í™”í•™íê¸°ë¬¼',
    },
    {
        name: 'Sodium Chloride',
        formula: 'NaCl',
        cas: '7647-14-5',
        ghs: [],
        location: 'Shelf C',
        storage: 'RT',
        quantity: 1000,
        density: 2.165,
        nfc_tag_uid: 'NFC-NACL-001',
        
        disposal: 'ì¼ë°˜íê¸°ë¬¼',
    },
];

let chemicals = [];
let suppressHashRoute = false;
let autocompleteTimer = null;
let autocompleteAbort = null;

function formatNumberDisplay(value, fractionDigits = 2) {
    if (value === undefined || value === null || Number.isNaN(Number(value))) {
        return '-';
    }
    return Number(value).toLocaleString(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: fractionDigits,
    });
}

function hasDensity(reagent) {
    return !!reagent && typeof reagent.density === 'number' && !Number.isNaN(reagent.density);
}

function parseGhsInput(value) {
    if(!value) return [];
    return value.split(',').map(s => s.trim()).filter(Boolean);
}

function escapeHtml(str) {
    if(str === undefined || str === null) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

// Branded alert/confirm/toast
function appAlert(message, opts={}) {
    return new Promise(resolve => {
        const overlay = document.createElement('div');
        overlay.className = 'app-modal-overlay';
        overlay.innerHTML = `
            <div class="app-modal">
                <header>${escapeHtml(opts.title || 'Reagent-ology')}</header>
                <div class="body">${escapeHtml(String(message || ''))}</div>
                <footer>
                    <button class="app-btn primary" id="__app_ok">í™•ì¸</button>
                </footer>
            </div>`;
        document.body.appendChild(overlay);
        const ok = overlay.querySelector('#__app_ok');
        const close = () => { overlay.remove(); resolve(true); };
        ok.addEventListener('click', close);
        overlay.addEventListener('click', (e)=>{ if(e.target===overlay) close(); });
    });
}

// Confirm dialog (branded)
function appConfirm(message, opts={}) {
    return new Promise(resolve => {
        const overlay = document.createElement('div');
        overlay.className = 'app-modal-overlay';
        overlay.innerHTML = `
            <div class="app-modal">
                <header>${escapeHtml(opts.title || 'Reagent-ology')}</header>
                <div class="body">${escapeHtml(String(message || ''))}</div>
                <footer>
                    <button class="app-btn" id="__app_cancel">ì·¨ì†Œ</button>
                    <button class="app-btn primary" id="__app_ok">í™•ì¸</button>
                </footer>
            </div>`;
        document.body.appendChild(overlay);
        const ok = overlay.querySelector('#__app_ok');
        const cancel = overlay.querySelector('#__app_cancel');
        const handleKey = (e) => {
            if(e.key === 'Enter') { e.preventDefault(); close(true); }
            else if(e.key === 'Escape') { e.preventDefault(); close(false); }
        };
        const close = (val) => {
            window.removeEventListener('keydown', handleKey);
            overlay.remove();
            resolve(val);
        };
        ok.addEventListener('click', () => close(true));
        cancel.addEventListener('click', () => close(false));
        overlay.addEventListener('click', (e)=>{ if(e.target===overlay) close(false); });
        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤: Enter=í™•ì¸, Esc=ì·¨ì†Œ
        window.addEventListener('keydown', handleKey);
        // ì´ˆì  ì´ë™: í™•ì¸ ë²„íŠ¼ìœ¼ë¡œ í¬ì»¤ìŠ¤
        setTimeout(()=>{ try{ ok.focus(); } catch(_){} }, 0);
    });
}

// Prompt dialog (branded)
function appPrompt(message, opts={}) {
    const {
        inputType = 'text',
        placeholder = '',
        defaultValue = ''
    } = opts || {};
    return new Promise(resolve => {
        const overlay = document.createElement('div');
        overlay.className = 'app-modal-overlay';
        overlay.innerHTML = `
            <div class="app-modal">
                <header>${escapeHtml(opts.title || 'Reagent-ology')}</header>
                <div class="body">
                    <div style="margin-bottom:8px;">${escapeHtml(String(message || ''))}</div>
                    <input id="__app_input" type="${escapeHtml(inputType)}" placeholder="${escapeHtml(placeholder)}" value="${escapeHtml(defaultValue)}" style="width:100%;padding:8px;border-radius:4px;box-sizing:border-box;"/>
                </div>
                <footer>
                    <button class="app-btn" id="__app_cancel">ì·¨ì†Œ</button>
                    <button class="app-btn primary" id="__app_ok">í™•ì¸</button>
                </footer>
            </div>`;
        document.body.appendChild(overlay);
        const input = overlay.querySelector('#__app_input');
        const ok = overlay.querySelector('#__app_ok');
        const cancel = overlay.querySelector('#__app_cancel');
        const close = (val) => { overlay.remove(); resolve(val); };
        ok.addEventListener('click', () => close(input.value));
        cancel.addEventListener('click', () => close(null));
        overlay.addEventListener('click', (e)=>{ if(e.target===overlay) close(null); });
        input.addEventListener('keyup', (e)=>{ if(e.key==='Enter') ok.click(); });
        input.focus();
        input.select();
    });
}

function appToast(message, duration=2000) {
    const node = document.createElement('div');
    node.className = 'app-toast';
    node.textContent = String(message || '');
    document.body.appendChild(node);
    setTimeout(()=>{ node.remove(); }, duration);
}

async function apiRequest(path, options = {}) {
    const url = `${API_BASE}${path}`;
    const config = { method: options.method || 'GET', headers: options.headers ? { ...options.headers } : {} };
    if(options.body !== undefined) {
        if(!(options.body instanceof FormData)) {
            config.body = JSON.stringify(options.body);
            config.headers['Content-Type'] = 'application/json';
        } else {
            config.body = options.body;
        }
    }
    const response = await fetch(url, config);
    const text = await response.text();
    let payload = null;
    if(text) {
        try {
            payload = JSON.parse(text);
        } catch (err) {
            payload = text;
        }
    }
    if(!response.ok) {
        const detail = payload && payload.detail ? payload.detail : response.statusText;
        throw new Error(detail || 'ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
    return payload;
}

function handleApiError(err, message) {
    console.error(err);
    appAlert(`${message}\n(${err.message || err})`);
}

function replaceReagentInState(reagent) {
    if(!reagent) return;
    const idx = chemicals.findIndex(c => c.id === reagent.id);
    if(idx >= 0) {
        chemicals[idx] = reagent;
    } else {
        chemicals.push(reagent);
    }
    chemicals.sort((a, b) => (a.id || 0) - (b.id || 0));
}

function removeReagentFromState(id) {
    chemicals = chemicals.filter(c => c.id !== id);
}

async function refreshReagents(showAlert = true) {
    try {
        const data = await apiRequest('/reagents');
        chemicals = Array.isArray(data) ? data : [];
    } catch (err) {
        chemicals = [];
        if(showAlert) handleApiError(err, 'ì‹œì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
}

async function seedDefaultDataIfNeeded() {
    try {
        if(localStorage.getItem(SEED_KEY)) return;
    } catch (err) {
        console.warn('LocalStorage unavailable, skip seeding.');
        return;
    }
    if(chemicals.length) return;
    try {
        for(const sample of DEFAULT_CHEMS) {
            const density = (typeof sample.density === 'number' && !Number.isNaN(sample.density)) ? sample.density : null;
            const quantity = (typeof sample.quantity === 'number' && !Number.isNaN(sample.quantity)) ? sample.quantity : 0;
            const volume_ml = (density && quantity) ? (quantity / density) : null;
            const ghs = Array.isArray(sample.ghs) ? sample.ghs : [];
            const payload = {
                name: sample.name,
                formula: sample.formula || '',
                cas: sample.cas || null,
                location: sample.location || 'Shelf',
                storage: sample.storage || null,
                state: sample.state || (density ? 'liquid' : 'solid'),
                expiry: null,
                hazard: ghs.join(', '),
                ghs,
                disposal: sample.disposal || null,
                density,
                volume_ml,
                nfc_tag_uid: sample.nfc_tag_uid || null,
                quantity,
            };
            await apiRequest('/reagents', { method: 'POST', body: payload });
        }
    } catch (e) {
        console.warn('Seeding failed/skipped:', e);
    }
    await refreshReagents(false);
    try {
        localStorage.setItem(SEED_KEY, '1');
    } catch (err) {
        console.warn('Failed to persist seed flag', err);
    }
}

function bindAutocomplete() {
    const nameInput = document.getElementById('name');
    const formulaInput = document.getElementById('formula');
    const datalist = document.getElementById('chemical-suggestions');
    if(!nameInput || !datalist) return;
    if(nameInput.dataset.autocompleteBound) return;
    nameInput.dataset.autocompleteBound = '1';

    nameInput.addEventListener('input', (event) => {
        const value = event.target.value.trim();
        if(autocompleteTimer) {
            clearTimeout(autocompleteTimer);
            autocompleteTimer = null;
        }
        if(value.length < 2) {
            datalist.innerHTML = '';
            return;
        }
        autocompleteTimer = setTimeout(async () => {
            const suggestions = await fetchAutocomplete(value);
            datalist.innerHTML = suggestions.map(item => {
                const label = item.formula ? `${item.name} (${item.formula})` : item.name;
                const attrParts = [];
                const safeFormula = escapeHtml(item.formula || '');
                attrParts.push(`data-formula="${safeFormula}"`);
                if(item.cas) attrParts.push(`data-cas="${escapeHtml(item.cas)}"`);
                if(item.storage) attrParts.push(`data-storage="${escapeHtml(item.storage)}"`);
                const ghsString = Array.isArray(item.ghs) ? item.ghs.join(', ') : (item.ghs || '');
                if(ghsString) attrParts.push(`data-ghs="${escapeHtml(ghsString)}"`);
                if(item.disposal) attrParts.push(`data-disposal="${escapeHtml(item.disposal)}"`);
                if(item.density !== undefined && item.density !== null && !Number.isNaN(Number(item.density))) {
                    attrParts.push(`data-density="${escapeHtml(String(item.density))}"`);
                }
                const attrString = attrParts.length ? ` ${attrParts.join(' ')}` : '';
                return `<option value="${escapeHtml(item.name)}"${attrString}>${label}</option>`;
            }).join('');
        }, 250);
    });

    // input ì´ë²¤íŠ¸ë¡œ ë³€ê²½í•˜ì—¬ ìë™ì™„ì„± ì„ íƒ ì‹œ ì¦‰ì‹œ ë°˜ì˜
    nameInput.addEventListener('input', () => {
        const currentValue = nameInput.value.trim();
        // datalistì—ì„œ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” í•­ëª© ì°¾ê¸°
        const matchedOption = Array.from(datalist.options).find(opt => opt.value === currentValue);
        if(!matchedOption) return;
        
        // í¼ í•„ë“œ ìë™ ì±„ìš°ê¸°
        if(matchedOption.dataset.formula && formulaInput) {
            formulaInput.value = matchedOption.dataset.formula;
        }
        const casInput = document.getElementById('cas');
        if(matchedOption.dataset.cas && casInput) {
            casInput.value = matchedOption.dataset.cas;
        }
        const storageInput = document.getElementById('storage');
        if(matchedOption.dataset.storage && storageInput) {
            storageInput.value = matchedOption.dataset.storage;
        }
        const hazardInput = document.getElementById('hazard');
        if(matchedOption.dataset.ghs && hazardInput) {
            hazardInput.value = matchedOption.dataset.ghs;
        }
        const disposalInput = document.getElementById('disposal');
        if(matchedOption.dataset.disposal && disposalInput) {
            disposalInput.value = matchedOption.dataset.disposal;
        }
        const densityInput = document.getElementById('density');
        if(matchedOption.dataset.density && densityInput) {
            densityInput.value = matchedOption.dataset.density;
        }
    });
}

let locationAutocompleteTimer = null;
let locationAutocompleteAbort = null;

function bindLocationAutocomplete() {
    const locationInput = document.getElementById('location');
    const datalist = document.getElementById('location-suggestions');
    if(!locationInput || !datalist) return;
    if(locationInput.dataset.autocompleteBound) return;
    locationInput.dataset.autocompleteBound = '1';

    locationInput.addEventListener('input', (event) => {
        const value = event.target.value.trim();
        if(locationAutocompleteTimer) {
            clearTimeout(locationAutocompleteTimer);
            locationAutocompleteTimer = null;
        }
        if(value.length < 1) {
            datalist.innerHTML = '';
            return;
        }
        locationAutocompleteTimer = setTimeout(async () => {
            const locations = await fetchLocationSuggestions(value);
            datalist.innerHTML = locations.map(loc => {
                return `<option value="${escapeHtml(loc)}"></option>`;
            }).join('');
        }, 200);
    });
}

async function fetchLocationSuggestions(query) {
    if(!query) return [];
    if(locationAutocompleteAbort) {
        locationAutocompleteAbort.abort();
    }
    locationAutocompleteAbort = new AbortController();
    
    try {
        const url = `${API_BASE}/locations?q=${encodeURIComponent(query)}`;
        console.log('Fetching locations from:', url);
        const res = await fetch(url, { 
            signal: locationAutocompleteAbort.signal 
        });
        if(!res.ok) {
            console.error('Location API returned status:', res.status);
            return [];
        }
        const locations = await res.json();
        console.log('Location suggestions received:', locations);
        return Array.isArray(locations) ? locations : [];
    } catch (err) {
        if(err.name === 'AbortError') return [];
        console.error('Location autocomplete error:', err);
        return [];
    }
}

async function fetchAutocomplete(query) {
    if(!query) return [];
    if(autocompleteAbort) {
        autocompleteAbort.abort();
    }
    autocompleteAbort = new AbortController();
    const limit = 8;
    try {
        // 1) ë¡œì»¬ DB ìš°ì„ 
        const localRes = await fetch(`${API_BASE}/autocomplete/local?q=${encodeURIComponent(query)}&limit=${limit}`, { signal: autocompleteAbort.signal });
        let suggestions = [];
        if(localRes.ok) {
            const payload = await localRes.json();
            suggestions = Array.isArray(payload.suggestions) ? payload.suggestions : [];
        }

        // 2) ì¶©ë¶„ì¹˜ ì•Šìœ¼ë©´ ì›ê²© ë³´ê°•
        if(suggestions.length < limit) {
            try {
                const remoteRes = await fetch(`${API_BASE}/autocomplete?q=${encodeURIComponent(query)}&limit=${limit}`, { signal: autocompleteAbort.signal });
                if(remoteRes.ok) {
                    const payloadR = await remoteRes.json();
                    const remote = Array.isArray(payloadR.suggestions) ? payloadR.suggestions : [];
                    const seen = new Set(suggestions.map(s => s.name));
                    for(const r of remote) {
                        if(!r || !r.name || seen.has(r.name)) continue;
                        suggestions.push(r);
                        seen.add(r.name);
                        if(suggestions.length >= limit) break;
                    }
                }
            } catch (err) {
                if(err.name !== 'AbortError') console.warn('Remote autocomplete failed', err);
            }
        }
        return suggestions;
    } catch (err) {
        if(err.name !== 'AbortError') console.warn('Autocomplete request failed', err);
        return [];
    }
}

function resetForm() {
    ['edit-id','name','formula','cas','location','storage','expiry','hazard','disposal','quantity','density','nfcTag'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = '';
    });
    const datalist = document.getElementById('chemical-suggestions');
    if(datalist) datalist.innerHTML = '';
}

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
    const pageEl = document.getElementById(pageId);
    if(pageEl) pageEl.style.display = 'block';
}

function navigateTo(route, param = '') {
    const path = param ? `#/` + route + `/` + encodeURIComponent(param) : `#/` + route;
    location.hash = path;
}

// ===== ë²ˆí˜¸/ë”ë¯¸/ë¼ìš°íŒ… ìœ í‹¸ =====
function isNumericString(val){
    return typeof val === 'string' && /^\d+$/.test(val.trim());
}

function findReagentByTagOrNumber(val){
    if(!val) return null;
    const s = String(val).trim();
    const num = /^\d+$/.test(s) ? Number(s) : null;
    // ìš°ì„  NFC UID ì¼ì¹˜
    let found = chemicals.find(c => (c.nfc_tag_uid || '') === s);
    if(found) return found;
    // ì´ë¦„ì´ ìˆ«ì ë¬¸ìì—´ì¸ ê²½ìš°
    found = chemicals.find(c => isNumericString(String(c.name || '')) && String(c.name) === s);
    if(found) return found;
    // ID ìˆ«ì ë§¤ì¹­ (ë³´ì¡°)
    if(num !== null){
        found = chemicals.find(c => Number(c.id) === num);
        if(found) return found;
    }
    return null;
}

function fillEditForm(c){
    if(!c) return;
    document.getElementById('edit-id').value = c.id;
    document.getElementById('name').value = c.name || '';
    document.getElementById('formula').value = c.formula || '';
    document.getElementById('cas').value = c.cas || '';
    document.getElementById('location').value = c.location || '';
    document.getElementById('storage').value = c.storage || '';
    document.getElementById('expiry').value = c.expiry ? c.expiry.slice(0,10) : '';
    document.getElementById('hazard').value = Array.isArray(c.ghs) && c.ghs.length ? c.ghs.join(', ') : (c.hazard || '');
    document.getElementById('disposal').value = c.disposal || '';
    document.getElementById('quantity').value = c.quantity ?? '';
    document.getElementById('density').value = c.density ?? '';
    document.getElementById('nfcTag').value = c.nfc_tag_uid || '';
    // ì„±ì§ˆ selectë¥¼ ghsë¡œë¶€í„° ìœ ì¶”
    const propSel = document.getElementById('propertyTag');
    if(propSel){
        const props = Array.isArray(c.ghs) ? c.ghs : [];
        const known = ["ê¸ˆì†","ë¹„ê¸ˆì†","ê¸ˆì†ì‚°í™”ë¬¼","ì‚°","ì—¼ê¸°","ì‚°í™”ì œ","í™˜ì›ì œ","í• ë¡œê²í™”ë¬¼","ìš©ë§¤"];
        const hit = known.find(k => props.includes(k));
        propSel.value = hit || '';
    }
    showPage('add');
}

function computeMaxNumeric(){
    let max = 0;
    for(const c of chemicals){
        const nameNum = isNumericString(String(c.name || '')) ? Number(c.name) : null;
        if(nameNum !== null && nameNum > max) max = nameNum;
        const tagNum = isNumericString(String(c.nfc_tag_uid || '')) ? Number(c.nfc_tag_uid) : null;
        if(tagNum !== null && tagNum > max) max = tagNum;
    }
    return max;
}

function getUsedStickerNumbers(){
    const set = new Set();
    for(const c of chemicals){
        const n1 = isNumericString(String(c.name || '')) ? Number(c.name) : null;
        if(n1 && n1 > 0) set.add(n1);
        const n2 = isNumericString(String(c.nfc_tag_uid || '')) ? Number(c.nfc_tag_uid) : null;
        if(n2 && n2 > 0) set.add(n2);
    }
    return set;
}

function smallestUnusedStickerNumber(){
    const used = getUsedStickerNumbers();
    let i = 1;
    while(used.has(i)) i++;
    return i;
}

function canonicalNumber(c){
    if(!c) return null;
    if(isNumericString(String(c.name || ''))) return Number(String(c.name));
    if(isNumericString(String(c.nfc_tag_uid || ''))) return Number(String(c.nfc_tag_uid));
    return null;
}

async function refreshNumbersPage(){
    if(!chemicals.length){
        await refreshReagents(false);
    }
    const max = computeMaxNumeric();
    const next = smallestUnusedStickerNumber();
    const maxEl = document.getElementById('current-max-number');
    const nextEl = document.getElementById('next-number');
    if(maxEl) maxEl.textContent = String(max);
    if(nextEl) nextEl.textContent = String(next);
}

// openNextAdd: deprecated UI, kept for compatibility
function openNextAdd(){
    const next = smallestUnusedStickerNumber();
    navigateTo('add', String(next));
}

async function createDummyWithNumber(n){
    const name = String(n);
    const uid = String(n);
    try {
        const saved = await apiRequest('/reagents', { method:'POST', body: { name, nfc_tag_uid: uid } });
        replaceReagentInState(saved);
        navigateTo('add', name);
    } catch(err){
        handleApiError(err, 'ë”ë¯¸ ìƒì„± ì‹¤íŒ¨');
    }
}

function createDummyNextAndEdit(){
    const next = smallestUnusedStickerNumber();
    createDummyWithNumber(next);
}

// í™”ë©´ ì „í™˜ ì—†ì´ ë”ë¯¸ë§Œ ì—°ì† ìƒì„±
async function createDummyNextQuick(){
    const next = smallestUnusedStickerNumber();
    try{
        const saved = await apiRequest('/reagents', { method:'POST', body:{ name: String(next), nfc_tag_uid: String(next) } });
        replaceReagentInState(saved);
        // ì„œë²„ ê¸°ì¤€ ìƒíƒœ ì¬ë™ê¸°í™”ëŠ” ê°€ë³ê²Œ ë°±ê·¸ë¼ìš´ë“œë¡œ
        refreshReagents(false).then(()=>{ rebuildInventoryFilters?.(); renderList(); });
        appToast(`ë”ë¯¸ ìƒì„±: ${next}`);
        // numbers í˜ì´ì§€ í‘œì‹œê°’ ì—…ë°ì´íŠ¸ ì‹œë„ (í˜„ì¬ í˜ì´ì§€ ë¬´ê´€)
        refreshNumbersPage().catch(()=>{});
    }catch(err){
        handleApiError(err, 'ë”ë¯¸ ìƒì„± ì‹¤íŒ¨');
    }
}

// ê¸°ì¡´ ìˆ«ìí˜• name ë”ë¯¸ ì¤‘ NFC UIDê°€ ë¹„ì–´ ìˆëŠ” ê²½ìš° ìë™ ë°±í•„
async function ensureNfcBackfill(){
    const candidates = chemicals.filter(c => isNumericString(String(c.name||'')) && !c.nfc_tag_uid);
    if(!candidates.length) return;
    for(const c of candidates){
        try {
            const num = String(c.name).trim();
            const updated = await apiRequest(`/reagents/${encodeURIComponent(c.slug)}`, { method:'PUT', body:{ nfc_tag_uid: num } });
            replaceReagentInState(updated);
        } catch(e){ console.warn('NFC backfill ì‹¤íŒ¨:', c.name, e); }
    }
    renderList();
}

// ì…ë ¥ê°’ ê¸°ë°˜ ëŒ€ëŸ‰ ë”ë¯¸ ìƒì„± íŠ¸ë¦¬ê±° (numbers íƒ­)
function createBulkDummiesFromInput(){
    const el = document.getElementById('bulk-dummy-count');
    const n = parseInt((el && el.value) ? el.value : '0', 10);
    createBulkDummies(n);
}

// ëŒ€ëŸ‰ ë”ë¯¸ ìƒì„±: í™”ë©´ ì „í™˜ ì—†ì´ ì—°ì† ë“±ë¡
async function createBulkDummies(count){
    const n = Number(count);
    if(!Number.isInteger(n) || n <= 0){ await appAlert('ìƒì„± ê°œìˆ˜ë¥¼ 1 ì´ìƒì˜ ì •ìˆ˜ë¡œ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    const cap = 500; // ì•ˆì „ ìƒí•œ
    const target = Math.min(n, cap);
    let first = null, last = null, success = 0;
    for(let i=0;i<target;i++){
        const next = smallestUnusedStickerNumber();
        try{
            const saved = await apiRequest('/reagents', { method:'POST', body:{ name: String(next), nfc_tag_uid: String(next) } });
            replaceReagentInState(saved);
            if(first===null) first = next;
            last = next;
            success++;
        }catch(err){
            console.error('bulk dummy create failed for', next, err);
            await appAlert(`ë”ë¯¸ ìƒì„± ì‹¤íŒ¨: ${next}\n${err.message||err}`);
            break;
        }
    }
    // ì„œë²„ì™€ ìµœì¢… ë™ê¸°í™”
    await refreshReagents(false);
    rebuildInventoryFilters?.();
    renderList();
    refreshNumbersPage().catch(()=>{});
    if(success){ appToast(`ë”ë¯¸ ${success}ê°œ ìƒì„± ì™„ë£Œ${first!==null?` (${first}${last!==first?`~${last}`:''})`:''}`); }
}

// ===== ì¶”ê°€/ìˆ˜ì • í˜ì´ì§€ìš© ì €ìš¸ ì—°ë™ =====
function openAddScaleModal() {
    // ê¸°ì¡´ showScaleModal ìŠ¤íƒ€ì¼ì˜ ê°„ë‹¨ ëª¨ë‹¬ë¡œ, ì½ì€ ë¬´ê²Œë¥¼ í¼ì˜ Quantityì— ì±„ì›Œë„£ê¸°ë§Œ í•¨
    const modal = document.createElement('div');
    modal.id = 'scale-modal-add';
    modal.style.cssText = `
        position: fixed; inset: 0; background: rgba(0,0,0,0.8);
        display: flex; justify-content: center; align-items: center; z-index: 1000;`;
    modal.innerHTML = `
        <div style="background: rgba(144,178,187,0.95); padding: 24px; border-radius: 12px; max-width: 480px; width: 90%;">
            <h2 style="margin-top: 0; color: white;">ì €ìš¸ì—ì„œ ì½ê¸° (ë“±ë¡/ìˆ˜ì •)</h2>
            <div style="margin: 16px 0;">
                <label style="color: white; display: block; margin-bottom: 8px;">ì‹œë¦¬ì–¼ í¬íŠ¸ ì„ íƒ:</label>
                <select id="scale-port-add" style="width: 100%; padding: 8px; border-radius: 4px;">
                    <option value="">í¬íŠ¸ ì„ íƒ...</option>
                </select>
                <button onclick="loadScalePortsForAdd()" style="margin-top: 8px; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">í¬íŠ¸ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="scale-weight-display-add" style="margin: 12px 0; padding: 16px; background: rgba(0,0,0,0.3); border-radius: 8px; text-align: center;">
                <div style="color: white; font-size: 14px; margin-bottom: 8px;">ì¸¡ì •ëœ ë¬´ê²Œ</div>
                <div id="scale-reading-add" style="color: #00ff00; font-size: 32px; font-weight: bold;">-- g</div>
                <div id="scale-status-add" style="color: #aaa; font-size: 12px; margin-top: 8px;">ëŒ€ê¸° ì¤‘...</div>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button onclick="readWeightForAdd()" style="padding: 10px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">ì €ìš¸ì—ì„œ ì½ê¸°</button>
                <button onclick="closeAddScaleModal()" style="padding: 10px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ë‹«ê¸°</button>
            </div>
        </div>`;
    document.body.appendChild(modal);
    loadScalePortsForAdd();
}

function closeAddScaleModal() {
    const modal = document.getElementById('scale-modal-add');
    if (modal) modal.remove();
}

async function loadScalePortsForAdd() {
    try {
        const res = await fetch(`${API_BASE}/scale/ports`);
        if(!res.ok) throw new Error('Failed to load ports');
        const data = await res.json();
        const sel = document.getElementById('scale-port-add');
        sel.innerHTML = '<option value="">í¬íŠ¸ ì„ íƒ...</option>';
        if(Array.isArray(data.ports) && data.ports.length) {
            for(const port of data.ports) {
                const opt = document.createElement('option');
                opt.value = port.device;
                opt.textContent = `${port.device} - ${port.description}`;
                sel.appendChild(opt);
            }
        } else {
            sel.innerHTML = '<option value="">ì‚¬ìš© ê°€ëŠ¥í•œ í¬íŠ¸ ì—†ìŒ</option>';
        }
    } catch (err) {
        console.error('loadScalePortsForAdd failed', err);
        document.getElementById('scale-status-add').textContent = 'í¬íŠ¸ ë¡œë“œ ì‹¤íŒ¨';
    }
}

async function readWeightForAdd() {
    const port = document.getElementById('scale-port-add').value;
    const statusEl = document.getElementById('scale-status-add');
    const readingEl = document.getElementById('scale-reading-add');
    if(!port) { statusEl.textContent = 'ì‹œë¦¬ì–¼ í¬íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.'; return; }
    statusEl.textContent = 'ì €ìš¸ì—ì„œ ì½ëŠ” ì¤‘...';
    statusEl.style.color = '#ffc107';
    try {
        const res = await fetch(`${API_BASE}/scale/weight?port=${encodeURIComponent(port)}`);
        if(!res.ok) throw new Error('Failed to read weight');
        const data = await res.json();
        const w = data.weight_grams;
        readingEl.textContent = `${formatNumberDisplay(w)} g`;
        statusEl.textContent = 'ì½ê¸° ì™„ë£Œ';
        statusEl.style.color = '#00ff00';
        // í¼ì— ë°˜ì˜
        const qty = document.getElementById('quantity');
        if(qty) qty.value = (typeof w === 'number' ? w : '');
    } catch (err) {
        console.error('readWeightForAdd failed', err);
        statusEl.textContent = 'ì½ê¸° ì‹¤íŒ¨';
        statusEl.style.color = '#ff0000';
        readingEl.textContent = '-- g';
    }
}

async function saveChemical() {
    const idValue = document.getElementById('edit-id').value;
    console.log('ğŸ’¾ Save Chemical - Edit ID:', idValue); // ë””ë²„ê·¸
    
    const name = document.getElementById('name').value.trim();
    const formula = document.getElementById('formula').value.trim();
    const cas = document.getElementById('cas').value.trim();
    const locationValue = document.getElementById('location').value.trim();
    const storage = document.getElementById('storage').value.trim();
    const expiry = document.getElementById('expiry').value;
    const hazard = document.getElementById('hazard').value.trim();
    const propertyTagEl = document.getElementById('propertyTag');
    const propertyTag = propertyTagEl ? propertyTagEl.value : '';
    const disposal = document.getElementById('disposal').value.trim();
    const quantityRaw = document.getElementById('quantity').value;
    const quantity = quantityRaw !== '' ? parseFloat(quantityRaw) : null; // ë¹„í•„ìˆ˜
    const densityRaw = document.getElementById('density').value;
    const stateEl = document.getElementById('state');
    const state = stateEl ? stateEl.value : '';
    const nfcTag = document.getElementById('nfcTag').value.trim();

    let density = null;
    if(densityRaw !== '') {
        const parsedDensity = parseFloat(densityRaw);
        if(Number.isNaN(parsedDensity) || parsedDensity <= 0) {
            await appAlert('ë°€ë„ëŠ” 0ë³´ë‹¤ í° ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }
        density = parsedDensity;
    } // ì„ íƒ ì…ë ¥

    // ìµœì†Œ ê²€ì¦: ì´ë¦„ë§Œ í•„ìˆ˜ (ìˆ˜ëŸ‰/ë°€ë„ ë“±ì€ ë¹„í•„ìˆ˜)
    if(!name) { await appAlert('ì´ë¦„(Name)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

    const payload = {
        name,
        formula,
        cas: cas || null,
        location: locationValue,
        storage: storage || null,
        state: state || null,
        expiry: expiry || null,
        hazard: hazard || null,
        ghs: (() => {
            const base = parseGhsInput(hazard);
            if(propertyTag && !base.includes(propertyTag)) base.push(propertyTag);
            return base;
        })(),
        disposal: disposal || null,
        density,
        volume_ml: (density && state === 'liquid' && typeof quantity === 'number' && !Number.isNaN(quantity)) ? quantity / density : null,
        nfc_tag_uid: nfcTag || null,
        quantity: (typeof quantity === 'number' && !Number.isNaN(quantity)) ? quantity : null,
    };

    const existing = idValue ? chemicals.find(c => c.id === Number(idValue)) : null;
    console.log('ğŸ” Existing reagent found:', existing ? `${existing.name} (slug: ${existing.slug})` : 'None - Creating new');

    try {
        let saved;
        if(existing) {
            console.log('âœï¸ Updating existing reagent via PUT');
            saved = await apiRequest(`/reagents/${encodeURIComponent(existing.slug)}`, {
                method: 'PUT',
                body: payload,
            });
        } else {
            console.log('â• Creating new reagent via POST');
            saved = await apiRequest('/reagents', {
                method: 'POST',
                body: payload,
            });
        }
    replaceReagentInState(saved);
    // ì €ì¥ í›„ ì¸ë²¤í† ë¦¬ë¡œ ì´ë™ + ì„œë²„ ìƒíƒœ ì¬ë™ê¸°í™”
    navigateTo('inventory');
    await refreshReagents(false);
    rebuildInventoryFilters?.();
    renderList();
        appToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì¸ë²¤í† ë¦¬ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');
    } catch (err) {
        handleApiError(err, 'ì‹œì•½ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
}

// Removed legacy purchase-based registration flow


function renderList() {
    const list = document.getElementById('chemical-list');
    const discardList = document.getElementById('discard-list');
    const usageList = document.getElementById('usage-list');
    if(list) list.innerHTML = '';
    if(discardList) discardList.innerHTML = '';
    if(usageList) usageList.innerHTML = '';

    const q = (document.getElementById('search')?.value || '').toLowerCase();
    const ghsFilter = document.getElementById('filterGHS')?.value || '';
    const propFilter = document.getElementById('filterProp')?.value || '';
    const locFilter = document.getElementById('filterLocation')?.value || '';
    const storageFilter = document.getElementById('filterStorage')?.value || '';
    const expiryFilter = document.getElementById('filterExpiry')?.value || '';
    const disposalFilter = document.getElementById('filterDisposal')?.value || '';
    const stateFilter = document.getElementById('filterState')?.value || '';
    const sortBy = document.getElementById('sortBy')?.value || 'name';

    let filtered = chemicals.filter(c => {
        if(q) {
            const text = `${c.name || ''} ${c.formula || ''} ${c.cas || ''}`.toLowerCase();
            if(!text.includes(q)) return false;
        }
        if(ghsFilter) {
            if(!Array.isArray(c.ghs) || !c.ghs.includes(ghsFilter)) return false;
        }
        if(propFilter){ if(!Array.isArray(c.ghs) || !c.ghs.includes(propFilter)) return false; }
        if(locFilter){ if((c.location||'') !== locFilter) return false; }
        if(storageFilter){ if((c.storage||'') !== storageFilter) return false; }
        if(disposalFilter){ if((c.disposal||'') !== disposalFilter) return false; }
        if(stateFilter){ if((c.state||'') !== stateFilter) return false; }
        if(expiryFilter){
            const today = new Date();
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
            const limit = todayStart + 10*24*60*60*1000; // +10ì¼
            const expTs = c.expiry ? Date.parse(c.expiry) : null;
            if(expiryFilter === 'expired'){ if(!(expTs && expTs < todayStart)) return false; }
            else if(expiryFilter === 'soon'){ if(!(expTs && expTs >= todayStart && expTs <= limit)) return false; }
        }
        return true;
    });

    if(sortBy === 'name') {
        filtered.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
    } else if(sortBy === 'quantity') {
        filtered.sort((a,b)=>(b.quantity||0)-(a.quantity||0));
    } else if(sortBy === 'prop') {
        const known=["ê¸ˆì†","ë¹„ê¸ˆì†","ê¸ˆì†ì‚°í™”ë¬¼","ì‚°","ì—¼ê¸°","ì‚°í™”ì œ","í™˜ì›ì œ","í• ë¡œê²í™”ë¬¼","ìš©ë§¤"]; const score=c=>{const g=Array.isArray(c.ghs)?c.ghs:[];const idx=known.findIndex(k=>g.includes(k));return idx===-1?999:idx;};
        filtered.sort((a,b)=> score(a)-score(b) || (a.id||0)-(b.id||0));
    } else if(sortBy === 'expiry') {
        const toTs=v=>v?Date.parse(v)||Infinity:Infinity; filtered.sort((a,b)=>toTs(a.expiry)-toTs(b.expiry));
    }

    filtered.forEach(c => {
        const li = document.createElement('li');

        const nameLink = document.createElement('a');
        nameLink.href = `#/reagents/${encodeURIComponent(c.slug)}`;
        nameLink.textContent = c.name;
        nameLink.style.fontWeight = '700';
        nameLink.style.color = '#00bfff';
        li.appendChild(nameLink);

        const info = document.createElement('div');
        const qtyDisplay = escapeHtml(formatNumberDisplay(c.quantity));
        const volumeDisplay = c.volume_ml !== null && c.volume_ml !== undefined
            ? escapeHtml(formatNumberDisplay(c.volume_ml))
            : null;
        const densityDisplay = c.density !== null && c.density !== undefined
            ? escapeHtml(formatNumberDisplay(c.density, 4))
            : null;
    const nfcDisplay = escapeHtml(c.nfc_tag_uid || '-');
        const numCanon = canonicalNumber(c);
        const nfcLinkPart = numCanon !== null
            ? ` &nbsp; <a href="${location.pathname}#/add/${encodeURIComponent(String(numCanon))}" target="_blank">ì—´ê¸°</a>`
            : '';
        const stateDisplay = c.state ? escapeHtml(c.state) : '-';

        let metaHtml = `<div style="margin-top:6px;">
            (${escapeHtml(c.formula || '')}) &nbsp; CAS: ${escapeHtml(c.cas || 'N/A')} &nbsp; | &nbsp; ìœ„ì¹˜: ${escapeHtml(c.location || 'N/A')}
            <br>ë³´ê´€: ${escapeHtml(c.storage || '-')} &nbsp; | &nbsp; ìƒíƒœ: ${stateDisplay} &nbsp; | &nbsp; ìœ í†µê¸°í•œ: ${escapeHtml(c.expiry || '-')} &nbsp; | &nbsp; íê¸°: ${escapeHtml(c.disposal || '-')}
            <br>ìˆ˜ëŸ‰: <strong>${qtyDisplay}</strong> g`;
        if(c.state === 'liquid' && volumeDisplay && volumeDisplay !== '-') {
            metaHtml += ` &nbsp; | &nbsp; ë¶€í”¼: ${volumeDisplay} mL`;
        }
        if(densityDisplay && densityDisplay !== '-') {
            metaHtml += ` &nbsp; | &nbsp; ë°€ë„: ${densityDisplay} g/mL`;
        }
    metaHtml += `<br>NFC: ${nfcDisplay}${nfcLinkPart}`;
        const ghsText = Array.isArray(c.ghs) && c.ghs.length ? c.ghs.join('; ') : '-';
        metaHtml += ` &nbsp; | &nbsp; GHS: ${escapeHtml(ghsText)}</div>`;
        info.innerHTML = metaHtml;
        li.appendChild(info);


        const btnContainer = document.createElement('div');
        btnContainer.style.marginTop = '8px';

        const actions = [
            {
                cls: 'edit',
                text: 'Edit',
                onClick: () => {
                    const num = canonicalNumber(c);
                    if(num !== null){
                        navigateTo('add', String(num));
                    } else {
                        fillEditForm(c);
                    }
                },
            },
            {
                cls: 'delete',
                text: 'Delete',
                onClick: () => deleteReagent(c),
            },
            {
                cls: 'use',
                text: 'Use -10',
                onClick: () => applyUsage(c, 'use', 10),
            },
            {
                cls: 'discard',
                text: 'Discard -10',
                onClick: () => applyUsage(c, 'discard', 10),
            },
            {
                cls: 'scale',
                text: 'Use with Scale',
                onClick: () => useWithScale(c),
            },
        ];

        actions.forEach(action => {
            const btn = document.createElement('button');
            btn.className = `action-btn ${action.cls}`;
            btn.textContent = action.text;
            btn.onclick = action.onClick;
            btnContainer.appendChild(btn);
        });

        li.appendChild(btnContainer);
        if(list) list.appendChild(li);

        if(discardList) {
            const liD = document.createElement('li');
            liD.textContent = `${c.name} - Discarded: ${c.discarded || 0}`;
            discardList.appendChild(liD);
        }

        if(usageList) {
            const liU = document.createElement('li');
            liU.textContent = `${c.name} - Used: ${c.used || 0}`;
            usageList.appendChild(liU);
        }
    });
}

async function deleteReagent(reagent) {
    const ok = await appConfirm(`${reagent.name}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    if(!ok) return;
    try {
        await apiRequest(`/reagents/${encodeURIComponent(reagent.slug)}`, { method: 'DELETE' });
        removeReagentFromState(reagent.id);
        await refreshReagents(false);
        rebuildInventoryFilters?.();
        renderList();
    } catch (err) {
        handleApiError(err, 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

async function applyUsage(reagent, endpoint, amount, note = '') {
    try {
        const updated = await apiRequest(`/reagents/${encodeURIComponent(reagent.slug)}/${endpoint}`, {
            method: 'POST',
            body: { amount, note },
        });
        replaceReagentInState(updated);
        await refreshReagents(false);
        renderList();
    } catch (err) {
        const actionLabel = endpoint === 'use' ? 'ì‚¬ìš©' : 'íê¸°';
        handleApiError(err, `${actionLabel} ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
    }
}

async function useWithScale(reagent) {
    const before = Number(reagent.quantity ?? 0);
    const densityHint = hasDensity(reagent)
        ? `, ë°€ë„ ${formatNumberDisplay(reagent.density, 4)} g/mL`
        : '';
    
    // ì €ìš¸ ìë™ ì¸¡ì • ëª¨ë‹¬ í‘œì‹œ
    showScaleModal(reagent, before, densityHint);
}

async function showScaleModal(reagent, currentWeight, densityHint) {
    // ëª¨ë‹¬ ìƒì„±
    const modal = document.createElement('div');
    modal.id = 'scale-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    modal.innerHTML = `
        <div style="background: rgba(144,178,187,0.95); padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
            <h2 style="margin-top: 0; color: white;">${escapeHtml(reagent.name)} - ì €ìš¸ ì¸¡ì •</h2>
            <p style="color: white;">í˜„ì¬ ë¬´ê²Œ: ${formatNumberDisplay(currentWeight)} g${densityHint}</p>
            
            <div id="scale-port-selection" style="margin: 20px 0;">
                <label style="color: white; display: block; margin-bottom: 8px;">ì‹œë¦¬ì–¼ í¬íŠ¸ ì„ íƒ:</label>
                <select id="scale-port" style="width: 100%; padding: 8px; border-radius: 4px;">
                    <option value="">í¬íŠ¸ ì„ íƒ...</option>
                </select>
                <button onclick="loadScalePorts()" style="margin-top: 8px; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    í¬íŠ¸ ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
            
            <div id="scale-weight-display" style="margin: 20px 0; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 8px; text-align: center;">
                <div style="color: white; font-size: 14px; margin-bottom: 8px;">ì¸¡ì •ëœ ë¬´ê²Œ</div>
                <div id="scale-reading" style="color: #00ff00; font-size: 36px; font-weight: bold;">-- g</div>
                <div id="scale-status" style="color: #aaa; font-size: 12px; margin-top: 8px;">ëŒ€ê¸° ì¤‘...</div>
            </div>
            
            <div style="margin: 20px 0;">
                <label style="color: white; display: block; margin-bottom: 8px;">ë©”ëª¨ (ì„ íƒì‚¬í•­):</label>
                <input type="text" id="scale-note" placeholder="ì¸¡ì • ë©”ëª¨..." style="width: 100%; padding: 8px; border-radius: 4px; box-sizing: border-box;">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="btn-scale-read" 
                    style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    ì €ìš¸ì—ì„œ ì½ê¸°
                </button>
                <button id="btn-manual-input" 
                    style="padding: 10px 20px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
                    ìˆ˜ë™ ì…ë ¥
                </button>
                <button onclick="closeScaleModal()" 
                    style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.getElementById('btn-scale-read').onclick = () => startScaleReading(reagent.slug, reagent.id);
    document.getElementById('btn-manual-input').onclick = () => manualScaleInput(reagent.slug, currentWeight);
    
    // í¬íŠ¸ ëª©ë¡ ë¡œë“œ
    loadScalePorts();
}

async function loadScalePorts() {
    try {
        const response = await fetch(`${API_BASE}/scale/ports`);
        if (!response.ok) throw new Error('Failed to load ports');
        
        const data = await response.json();
        const select = document.getElementById('scale-port');
        
        select.innerHTML = '<option value="">í¬íŠ¸ ì„ íƒ...</option>';
        
        if (data.ports && data.ports.length > 0) {
            data.ports.forEach(port => {
                const option = document.createElement('option');
                option.value = port.device;
                option.textContent = `${port.device} - ${port.description}`;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">ì‚¬ìš© ê°€ëŠ¥í•œ í¬íŠ¸ ì—†ìŒ</option>';
        }
    } catch (err) {
        console.error('Failed to load scale ports:', err);
        const msg = (err && err.message === 'Failed to fetch')
            ? 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.'
            : 'í¬íŠ¸ ë¡œë“œ ì‹¤íŒ¨';
        document.getElementById('scale-status').textContent = msg;
    }
}

async function startScaleReading(reagentSlug, reagentId) {
    const port = document.getElementById('scale-port').value;
    const note = document.getElementById('scale-note').value;
    
    if (!port) {
        appAlert('ì‹œë¦¬ì–¼ í¬íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const statusEl = document.getElementById('scale-status');
    const readingEl = document.getElementById('scale-reading');
    
    statusEl.textContent = 'ì €ìš¸ ì—°ê²° ì¤‘...';
    statusEl.style.color = '#ffc107';
    
    try {
        // ì €ìš¸ì—ì„œ ë¬´ê²Œ ì½ê³  ì‹œì•½ ì—…ë°ì´íŠ¸
        const response = await fetch(
            `${API_BASE}/reagents/${reagentId}/measure-weight?port=${encodeURIComponent(port)}&note=${encodeURIComponent(note || '')}`,
            { method: 'POST' }
        );
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to read from scale');
        }
        
        const result = await response.json();
        
        // ê²°ê³¼ í‘œì‹œ
        readingEl.textContent = `${formatNumberDisplay(result.measured_weight)} g`;
        statusEl.textContent = 'ì¸¡ì • ì™„ë£Œ!';
        statusEl.style.color = '#00ff00';
        
        // ì‹œì•½ ë°ì´í„° ì—…ë°ì´íŠ¸
        replaceReagentInState(result.reagent);
        renderList();
        
        // ì ì‹œ í›„ ëª¨ë‹¬ ë‹«ê¸°
        setTimeout(async () => {
            closeScaleModal();
            const volumeDisplay = result.reagent.volume_ml !== null && result.reagent.volume_ml !== undefined
                ? formatNumberDisplay(result.reagent.volume_ml)
                : null;
            await appAlert(`ì¸¡ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ë¬´ê²Œ: ${formatNumberDisplay(result.measured_weight)} g${volumeDisplay ? `\në¶€í”¼: ${volumeDisplay} mL` : ''}\në³€í™”ëŸ‰: ${result.delta > 0 ? '+' : ''}${formatNumberDisplay(result.delta)} g`);
        }, 1500);
        
    } catch (err) {
        console.error('Scale reading failed:', err);
        const msg = (err && err.message === 'Failed to fetch')
            ? 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.'
            : (err && err.message) ? err.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
        statusEl.textContent = `ì˜¤ë¥˜: ${msg}`;
        statusEl.style.color = '#ff0000';
        readingEl.textContent = '-- g';
    }
}

async function manualScaleInput(reagentSlug, currentWeight) {
    const densityHint = '';
    const promptLabel = `ì €ìš¸ë¡œ ì° ë¬´ê²Œ(g)ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í˜„ì¬: ${formatNumberDisplay(currentWeight)} g)`;
    const massStr = await appPrompt(promptLabel, { inputType: 'number', placeholder: '0.00' });
    if(massStr === null) return;
    
    const measuredMass = parseFloat(massStr);
    if(Number.isNaN(measuredMass) || measuredMass < 0) {
        appAlert('ì˜¬ë°”ë¥¸ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (0 ì´ìƒì˜ ìˆ«ì).');
        return;
    }
    
    if(!Number.isNaN(currentWeight) && measuredMass > currentWeight) {
        const ok = await appConfirm('ì…ë ¥í•œ ê°’ì´ í˜„ì¬ ë¬´ê²Œë³´ë‹¤ í½ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if(!ok) return;
    }
    
    const note = document.getElementById('scale-note')?.value || '';
    
    try {
        const updated = await apiRequest(`/reagents/${encodeURIComponent(reagentSlug)}/measurement`, {
            method: 'POST',
            body: { measured_mass: measuredMass, source: 'manual', note },
        });
        replaceReagentInState(updated);
        renderList();
        closeScaleModal();
        
        const massDisplay = formatNumberDisplay(updated.quantity);
        const volumeDisplay = updated.volume_ml !== null && updated.volume_ml !== undefined
            ? formatNumberDisplay(updated.volume_ml)
            : null;
        await appAlert(`ì¸¡ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ë¬´ê²Œ: ${massDisplay} g${volumeDisplay ? `, ë¶€í”¼: ${volumeDisplay} mL` : ''}`);
    } catch (err) {
        handleApiError(err, 'ì¸¡ì •ê°’ì„ ë°˜ì˜í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
}

function closeScaleModal() {
    const modal = document.getElementById('scale-modal');
    if (modal) {
        modal.remove();
    }
}

async function triggerManualMeasurement(id) {
    const reagent = chemicals.find(c => c.id === id);
    if(!reagent) return;
    await useWithScale(reagent);
}

async function resetUsageStats() {
    const ok = await appConfirm('ëª¨ë“  ì‚¬ìš©/íê¸° í†µê³„ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
    if(!ok) return;
    try {
        await apiRequest('/reagents/reset-stats', { method: 'POST' });
        await refreshReagents();
        renderList();
    } catch (err) {
        handleApiError(err, 'í†µê³„ë¥¼ ì´ˆê¸°í™”í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
}

function exportCSV() {
    if(!chemicals.length) {
        appAlert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    const rows = [['id','name','formula','cas','location','storage','state','expiry','quantity_g','volume_ml','density_g_ml','ghs','used','discarded','disposal','nfc_tag_uid']];
    chemicals.forEach(c => {
        rows.push([
            c.id,
            c.name || '',
            c.formula || '',
            c.cas || '',
            c.location || '',
            c.storage || '',
            c.state || '',
            c.expiry || '',
            c.quantity ?? 0,
            c.volume_ml ?? '',
            c.density ?? '',
            Array.isArray(c.ghs) ? c.ghs.join(';') : '',
            c.used ?? 0,
            c.discarded ?? 0,
            c.disposal || '',
            c.nfc_tag_uid || ''
        ]);
    });
    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `reagentology_export_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
}

async function exportXLSX(){
    try {
        const res = await fetch(`${API_BASE}/export/reagents.xlsx`);
        if(!res.ok){
            const text = await res.text();
            appAlert(`XLSX ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ${text || res.status}`);
            return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reagentology_export_${new Date().toISOString().slice(0,10)}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        appToast('XLSX íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
    } catch(err){
        handleApiError(err, 'XLSX íŒŒì¼ ìƒì„± ì‹¤íŒ¨');
    }
}

// ì¸ë²¤í† ë¦¬ í•„í„° ë“œë¡­ë‹¤ìš´ ë™ì  êµ¬ì„±
function rebuildInventoryFilters(){
    const ghsSel = document.getElementById('filterGHS');
    const locSel = document.getElementById('filterLocation');
    const storageSel = document.getElementById('filterStorage');
    const expirySel = document.getElementById('filterExpiry');
    const disposalSel = document.getElementById('filterDisposal');
    const stateSel = document.getElementById('filterState');
    if(!ghsSel || !locSel || !storageSel || !expirySel || !disposalSel || !stateSel) return;

    const ghsSet = new Set();
    const locSet = new Set();
    const storageSet = new Set();
    const disposalSet = new Set();
    const stateSet = new Set();

    chemicals.forEach(c => {
        if(Array.isArray(c.ghs)) c.ghs.forEach(g => g && ghsSet.add(g));
        if(c.location) locSet.add(c.location);
        if(c.storage) storageSet.add(c.storage);
        if(c.disposal) disposalSet.add(c.disposal);
        if(c.state) stateSet.add(c.state);
    });

    const buildOptions = (set, labelAll) => {
        const arr = Array.from(set).sort();
        return `<option value="">${labelAll}</option>` + arr.map(v => `<option>${escapeHtml(v)}</option>`).join('');
    };

    ghsSel.innerHTML = buildOptions(ghsSet, '--GHS ë¶„ë¥˜--');
    locSel.innerHTML = buildOptions(locSet, '--ìœ„ì¹˜--');
    storageSel.innerHTML = buildOptions(storageSet, '--ë³´ê´€ ì¡°ê±´--');
    // ê³ ì • ìƒíƒœ ì˜µì…˜ìœ¼ë¡œ êµ¬ì„± (ì§€ë‚¨/ì„ë°•)
    expirySel.innerHTML = `<option value="">--ìœ í†µê¸°í•œ ìƒíƒœ--</option><option value="expired">ìœ í†µê¸°í•œ ì§€ë‚¨</option><option value="soon">ìœ í†µê¸°í•œ ì„ë°•(10ì¼)</option>`;
    disposalSel.innerHTML = buildOptions(disposalSet, '--íê¸° ë°©ë²•--');
    stateSel.innerHTML = `<option value="">--ìƒíƒœ--</option>`
        + Array.from(stateSet).sort().map(v => `<option value="${escapeHtml(v)}">${v==='solid'?'solid(ê³ ì²´)':v==='liquid'?'liquid(ì•¡ì²´)':escapeHtml(v)}</option>`).join('');
}

function autoDiscardReport() {
    if(!chemicals.length) {
        appAlert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    const rows = [['name','discarded']];
    chemicals.forEach(c => rows.push([c.name || '', c.discarded || 0]));
    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `discard_report_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
}

async function renderUsageLogList(slug) {
    const box = document.getElementById('usage-log');
    if(!box) return;
    box.innerHTML = '<li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>';
    try {
        const logs = await apiRequest(`/reagents/${encodeURIComponent(slug)}/usage`);
        if(!logs || !logs.length) {
            box.innerHTML = '<li>ê¸°ë¡ ì—†ìŒ</li>';
            return;
        }
        box.innerHTML = logs.map(log => {
            const when = new Date(log.created_at).toLocaleString();
            const sign = log.delta > 0 ? '+' : '';
            return `<li>
                <span>${escapeHtml(when)}</span>
                &nbsp; <strong>${sign}${log.delta}</strong> â†’ ${log.new_qty}
                &nbsp; <em style="opacity:.7">${escapeHtml(log.source || '')}</em>
                ${log.note ? `&nbsp; <span>${escapeHtml(log.note)}</span>` : ''}
            </li>`;
        }).join('');
    } catch (err) {
        box.innerHTML = '<li>ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
        console.error(err);
    }
}

function showChemicalDetail(id) {
    const chem = chemicals.find(c => c.id == id);
    if(!chem) {
        appAlert('ì‹œì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    const detailDiv = document.getElementById('chemical-detail');
    if(detailDiv) {
        detailDiv.innerHTML = `
            <h2 style="margin-bottom:6px">${escapeHtml(chem.name)}</h2>
            <div class="meta" style="opacity:.8;margin-bottom:10px">
              ID: ${chem.id} &nbsp;|&nbsp; slug: ${escapeHtml(chem.slug)}
            </div>

            <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:start">
                            <div>
                                                                <p><strong>ìˆ˜ëŸ‰ (g)</strong>: <span id="chem-qty">${escapeHtml(formatNumberDisplay(chem.quantity))}</span></p>
                                                                ${chem.state === 'liquid' && chem.volume_ml != null ? `<p><strong>ë¶€í”¼ (mL)</strong>: ${escapeHtml(formatNumberDisplay(chem.volume_ml))}</p>` : ''}
                                                                <p><strong>ë°€ë„ (g/mL)</strong>: ${escapeHtml(formatNumberDisplay(chem.density, 4))}</p>
                                <p><strong>CAS</strong>: ${escapeHtml(chem.cas || '-')}</p>
                                <p><strong>Formula</strong>: ${escapeHtml(chem.formula || '-')}</p>
                                <p><strong>Location</strong>: ${escapeHtml(chem.location || '-')}</p>
                                                                <p><strong>Storage</strong>: ${escapeHtml(chem.storage || '-')}</p>
                                                                <p><strong>ìƒíƒœ</strong>: ${escapeHtml(chem.state || '-')}</p>
                                <p><strong>Expiry</strong>: ${escapeHtml(chem.expiry || '-')}</p>
              </div>
              <div>
                <p><strong>Hazard</strong>: ${escapeHtml(chem.hazard || '-')}</p>
                <p><strong>Disposal</strong>: ${escapeHtml(chem.disposal || '-')}</p>
                <p><strong>Used</strong>: ${chem.used ?? 0}</p>
                <p><strong>Discarded</strong>: ${chem.discarded ?? 0}</p>
                <p><strong>GHS</strong>: ${
                    Array.isArray(chem.ghs) && chem.ghs.length
                        ? escapeHtml(chem.ghs.join('; '))
                        : '-'
                }</p>
                                                                <p><strong>NFC Tag</strong>: ${escapeHtml(chem.nfc_tag_uid || '-')}</p>
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:6px;flex-wrap:wrap">
                            <button class="small" onclick="triggerManualMeasurement($chem.id)">ìˆ˜ë™ ë³€ê²½</button>
                            <button class="small" onclick="navigateTo('inventory')">ëª©ë¡ìœ¼ë¡œ</button>
              <button class="small" onclick="copyReagentLink('${encodeURIComponent(chem.slug)}')">ë§í¬ ë³µì‚¬</button>
            </div>

            <h3 style="margin-top:16px">ì‚¬ìš© ê¸°ë¡</h3>
            <ul id="usage-log" style="margin:0;padding-left:18px"></ul>
        `;
        renderUsageLogList(chem.slug);
    }
    showPage('detail-page');
}

async function copyReagentLink(slugOrEncoded) {
    const slug = decodeURIComponent(slugOrEncoded);
    const url = `${location.origin}${location.pathname}#/reagents/${encodeURIComponent(slug)}`;
    try {
        await navigator.clipboard.writeText(url);
        appToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    } catch (err) {
        console.warn('Clipboard write failed', err);
        await appPrompt('ë³µì‚¬ ì‹¤íŒ¨. ì•„ë˜ ë§í¬ë¥¼ ìˆ˜ë™ ë³µì‚¬í•˜ì„¸ìš”:', { defaultValue: url });
    }
}

// NFC ìŠ¤í‹°ì»¤ URL ìƒì„± ë° ë³µì‚¬ ìœ í‹¸
function getStickerOrigin() {
    try {
        const v = localStorage.getItem(STICKER_HOST_KEY);
        if(v && /^https?:\/\//i.test(v)) return v.replace(/\/$/, '');
    } catch (e) { /* ignore */ }
    return location.origin; // ê¸°ë³¸ì€ í˜„ì¬ ì ‘ì† í˜¸ìŠ¤íŠ¸
}


function setStickerOrigin(origin) {
    if(!origin) return;
    try {
        localStorage.setItem(STICKER_HOST_KEY, origin.replace(/\/$/, ''));
    } catch (e) { /* ignore */ }
}

function generateNfcUrl(uid) {
    if(!uid) return '';
    const origin = getStickerOrigin();
    return `${origin}${location.pathname}#/r/${encodeURIComponent(uid)}`;
}

async function copyNfcLink(uid) {
    const url = generateNfcUrl(uid);
    if(!url) return;
    try {
        await navigator.clipboard.writeText(url);
        appToast('NFC ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    } catch (err) {
        console.warn('Clipboard write failed', err);
        await appPrompt('ë³µì‚¬ ì‹¤íŒ¨. ì•„ë˜ ë§í¬ë¥¼ ìˆ˜ë™ ë³µì‚¬í•˜ì„¸ìš”:', { defaultValue: url });
    }
}

// í—¤ë”ì— NFC UID ë¹ ë¥¸ ì´ë™ ì…ë ¥ì°½ ì¶”ê°€
function setupHeaderNfcJump() {
    const container = document.querySelector('.topbar-right');
    if(!container) return;
    if(container.querySelector('#number-jump-input')) return; // ì¤‘ë³µ ë°©ì§€

    // ë²ˆí˜¸ë¡œ ë°”ë¡œ ì´ë™ ì…ë ¥
    const input = document.createElement('input');
    input.type = 'text';
    input.id = 'number-jump-input';
    input.placeholder = 'ë²ˆí˜¸';
    input.style.padding = '6px';
    input.style.minWidth = '80px';

    const jumpBtn = document.createElement('button');
    jumpBtn.className = 'small';
    jumpBtn.textContent = 'ë²ˆí˜¸ ì´ë™';
    jumpBtn.style.marginLeft = '4px';
    const jumpByNumber = async () => {
        const val = input.value.trim();
        if(!val) { await appAlert('ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        if(!/^\d+$/.test(val)) { await appAlert('ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        navigateTo('add', val);
    };
    jumpBtn.onclick = jumpByNumber;
    input.addEventListener('keyup', (e)=>{ if(e.key==='Enter') jumpByNumber(); });

    // ì¸ìŠ¤í„´íŠ¸ ë”ë¯¸ ìƒì„± ë²„íŠ¼
    const instantBtn = document.createElement('button');
    instantBtn.className = 'small';
    instantBtn.textContent = 'ì¸ìŠ¤í„´íŠ¸ ìƒì„±';
    instantBtn.style.marginLeft = '4px';
    instantBtn.onclick = () => createDummyNextAndEdit();

    container.appendChild(input);
    container.appendChild(jumpBtn);
    container.appendChild(instantBtn);
}

// ì¶”ê°€/ìˆ˜ì • í¼ì˜ NFC ì…ë ¥ ì˜†ì— ìŠ¤í‹°ì»¤ URL ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
function setupNfcUrlPreview() {
    const nfcInput = document.getElementById('nfcTag');
    if(!nfcInput) return;

    let preview = document.getElementById('nfc-url-preview');
    if(!preview) {
        preview = document.createElement('div');
        preview.id = 'nfc-url-preview';
        preview.style.fontSize = '0.9rem';
        preview.style.opacity = '0.85';
        preview.style.marginTop = '6px';
        nfcInput.parentElement && nfcInput.parentElement.appendChild(preview);
    }

    const update = () => {
        const uid = nfcInput.value.trim();
        if(uid) {
            const url = generateNfcUrl(uid);
            preview.innerHTML = `ìŠ¤í‹°ì»¤ URL: <a href="${url}" target="_blank">${url}</a> ` +
                `<button type="button" class="small" onclick="copyNfcLink('${uid.replace(/'/g, "&#39;")}')">ë³µì‚¬</button>`;
        } else {
            preview.textContent = 'ìŠ¤í‹°ì»¤ URL: (NFC Tag UID ì…ë ¥ ì‹œ ìë™ ìƒì„±)';
        }
    };
    nfcInput.addEventListener('input', update);
    update();
}

function parseHash() {
    const h = (location.hash || '').replace(/^#\/?/, '');
    const [route, param] = h.split('/');
    return { route: route || '', param: param || '' };
}

function handleHashRoute() {
    const { route, param } = parseHash();
    const loggedUser = localStorage.getItem(LOGGED_KEY);
    if(!loggedUser) {
        showPage('login-page');
        return;
    }
    // add ë¼ìš°íŠ¸: #/add/<uid or number>
    if(route === 'add' && param){
        const v = decodeURIComponent(param);
        const match = findReagentByTagOrNumber(v);
        if(match){
            fillEditForm(match); // URL ìœ ì§€, í¸ì§‘ í¼ ë°”ì¸ë”©
        } else {
            resetForm();
            document.getElementById('name').value = v;
            document.getElementById('nfcTag').value = v;
            showPage('add');
        }
        return;
    }
      // âœ… NFC ë¼ìš°íŠ¸ ì¶”ê°€ (ì´ ë¶€ë¶„ ìƒˆë¡œ ì¶”ê°€)
  // URLì´ #/r/<tag_uid> í˜•ì‹ì´ë©´ ìŠ¤ìº” í˜ì´ì§€ë¡œ ì´ë™
    if(route === 'r' && param){
        const tagUid = decodeURIComponent(param);
        const match = findReagentByTagOrNumber(tagUid);
        if(match){
            // r/<uid>ë¡œ ë“¤ì–´ì™”ë”ë¼ë„, í¸ì§‘ì€ add/<number> ì£¼ì†Œë¡œ í†µì¼
            const num = canonicalNumber(match);
            if(num){
                navigateTo('add', String(num));
            } else {
                fillEditForm(match);
            }
        } else {
                    if(isNumericString(tagUid)){
                        const go = confirm(`#/r/${tagUid} ì— í•´ë‹¹í•˜ëŠ” ì‹œì•½ì´ ì—†ìŠµë‹ˆë‹¤. ì§€ê¸ˆ ë”ë¯¸ë¡œ ìƒì„±í• ê¹Œìš”?`);
                        if(go){
                            createDummyWithNumber(parseInt(tagUid,10)).catch(err=>handleApiError(err,'ë”ë¯¸ ìƒì„± ì‹¤íŒ¨'));
                        } else {
                            // ë¹ ë¥¸ ë“±ë¡ì„ ìœ„í•´ ê¸°ë³¸ê°’ ì±„ì›€
                            resetForm();
                            document.getElementById('name').value = tagUid;
                            document.getElementById('nfcTag').value = tagUid;
                            showPage('add');
                        }
                    } else {
                        resetForm();
                        document.getElementById('nfcTag').value = tagUid;
                        showPage('add');
                    }
        }
        return;
    }
    // ì •ì  ì„¹ì…˜ ë¼ìš°íŒ…
    const pages = new Set(['about','add','numbers','discard','inventory','usage']);
    if(pages.has(route)) {
        showPage(route);
        if(route === 'inventory') {
            // ì¸ë²¤í† ë¦¬ ì§„ì… ì‹œ ì„œë²„ì™€ ë™ê¸°í™” í›„ ë Œë”
            refreshReagents(false).then(()=>{ rebuildInventoryFilters?.(); renderList(); });
        }
        if(route === 'numbers') refreshNumbersPage();
        return;
    }
    if(route === 'reagents' && param) {
        let chem = chemicals.find(c => c.slug === decodeURIComponent(param));
        if(!chem) {
            const idNum = Number(param);
            if(!Number.isNaN(idNum)) chem = chemicals.find(c => c.id === idNum);
        }
        if(chem) {
            showChemicalDetail(chem.id);
            return;
        }
    }
    showPage('about');
}

// NFC í˜ì´ì§€ ë Œë” í•¨ìˆ˜
async function renderScanPage(tag_uid, isInit){
    const about = document.getElementById('about');
    about.innerHTML = `
        <h2>NFC: ${escapeHtml(tag_uid)}</h2>
        <div id="scan-status">${isInit ? 'ì´ˆê¸° ë¬´ê²Œ ì¸¡ì • ëŒ€ê¸°ì¤‘â€¦ (ê°€ë“ ì°¬ ìƒíƒœë¡œ ì˜¬ë ¤ ì£¼ì„¸ìš”)' : 'ë¬´ê²Œ ì¸¡ì • ëŒ€ê¸°ì¤‘â€¦'}</div>
        <div id="scan-info" style="margin-top:10px"></div>
        <div id="scan-actions" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;"></div>
    `;

    async function loadByTag(){
        try {
            const reagent = await apiRequest(`/reagents/by-nfc/${encodeURIComponent(tag_uid)}`);
            // ìƒíƒœ ì˜ì—­
            const qty = typeof reagent.quantity === 'number' ? `${formatNumberDisplay(reagent.quantity)} g` : '-';
            const vol = (reagent.state === 'liquid' && reagent.volume_ml != null) ? `, ${formatNumberDisplay(reagent.volume_ml)} mL` : '';
            const info = `
                <div>
                    <strong>${escapeHtml(reagent.name)}</strong> (${escapeHtml(reagent.formula || '-')})<br/>
                    ìœ„ì¹˜: ${escapeHtml(reagent.location || '-')}
                    &nbsp;|&nbsp; ìƒíƒœ: ${escapeHtml(reagent.state || '-')}
                    &nbsp;|&nbsp; ë°€ë„: ${escapeHtml(formatNumberDisplay(reagent.density,4))}
                    <br/>í˜„ì¬ ì”ëŸ‰: ${qty}${vol}
                </div>`;
            document.getElementById('scan-info').innerHTML = info;

            // ì•¡ì…˜ ì˜ì—­
            const actions = document.getElementById('scan-actions');
            actions.innerHTML = '';

            const input = document.createElement('input');
            input.type = 'number';
            input.step = '0.01';
            input.placeholder = 'ì¸¡ì • ë¬´ê²Œ(g) ìˆ˜ë™ ì…ë ¥';
            input.style.padding = '6px';
            input.id = 'nfc-manual-mass';

            const noteInput = document.createElement('input');
            noteInput.type = 'text';
            noteInput.placeholder = 'ë©”ëª¨(ì„ íƒ)';
            noteInput.style.padding = '6px';
            noteInput.id = 'nfc-manual-note';

            const btnSave = document.createElement('button');
            btnSave.className = 'action-btn use';
            btnSave.textContent = 'ìˆ˜ë™ ì €ì¥';
            btnSave.onclick = async () => {
                const v = parseFloat(document.getElementById('nfc-manual-mass').value);
                const note = document.getElementById('nfc-manual-note').value.trim();
                if(Number.isNaN(v) || v < 0){ await appAlert('ì˜¬ë°”ë¥¸ ë¬´ê²Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (0 ì´ìƒ).'); return; }
                try {
                    const updated = await apiRequest('/measurements/weight', {
                        method: 'POST',
                        body: { nfc_tag_uid: tag_uid, measured_mass: v, source: 'nfc-manual', note }
                    });
                    replaceReagentInState(updated);
                    renderList();
                    await loadByTag();
                    appToast('ì¸¡ì •ê°’ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (err) {
                    handleApiError(err, 'ì €ì¥ ì‹¤íŒ¨');
                }
            };

            const btnScale = document.createElement('button');
            btnScale.className = 'action-btn scale';
            btnScale.textContent = 'ì €ìš¸ì—ì„œ ì½ê¸°';
            btnScale.onclick = () => useWithScale(reagent);

            const btnDetail = document.createElement('button');
            btnDetail.className = 'small';
            btnDetail.textContent = 'ìƒì„¸ ë³´ê¸°';
            btnDetail.onclick = () => navigateTo('reagents', reagent.slug);

            const btnBack = document.createElement('button');
            btnBack.className = 'small';
            btnBack.textContent = 'ëª©ë¡ìœ¼ë¡œ';
            btnBack.onclick = () => navigateTo('inventory');

            actions.appendChild(input);
            actions.appendChild(noteInput);
            actions.appendChild(btnSave);
            actions.appendChild(btnScale);
            actions.appendChild(btnDetail);
            actions.appendChild(btnBack);

            document.getElementById('scan-status').textContent = 'ì¸¡ì • ëŒ€ê¸°/ì§„í–‰ ì¤‘â€¦';
        } catch (err) {
            document.getElementById('scan-info').textContent = 'í•´ë‹¹ NFC íƒœê·¸ë¡œ ë“±ë¡ëœ ì‹œì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            document.getElementById('scan-status').textContent = 'ë¯¸ë“±ë¡ íƒœê·¸';
        }
    }

    await loadByTag();
    clearInterval(window.__scanTimer);
    window.__scanTimer = setInterval(loadByTag, 5000);
}


window.addEventListener('hashchange', () => {
    if(suppressHashRoute) return;
    handleHashRoute();
});

document.querySelectorAll('nav button').forEach(btn => btn.addEventListener('click', () => {
    setTimeout(renderList, 120);
}));

async function signup() {
    const username = await appPrompt('ì‚¬ìš©í•  Username ì…ë ¥:');
    const password = await appPrompt('ì‚¬ìš©í•  Password ì…ë ¥:', { inputType: 'password' });
    if(!username || !password) { appAlert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    let users = [];
    try {
        users = JSON.parse(localStorage.getItem(USER_KEY) || '[]');
    } catch (err) {
        console.warn('LocalStorage unavailable', err);
    }
    if(users.some(u => u.username === username)) { appAlert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.'); return; }
    users.push({ username, password });
    localStorage.setItem(USER_KEY, JSON.stringify(users));
    appToast('íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
}

async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    if(!username || !password) { await appAlert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    let users = [];
    try {
        users = JSON.parse(localStorage.getItem(USER_KEY) || '[]');
    } catch (err) {
        console.warn('LocalStorage unavailable', err);
    }
    const user = users.find(u => u.username === username && u.password === password);
    if(user) {
        localStorage.setItem(LOGGED_KEY, username);
        document.getElementById('login-page').style.display='none';
        document.getElementById('main-page').style.display='block';
        document.getElementById('whoami').textContent = username;
        document.getElementById('logoutBtn').style.display = 'inline-block';
        await initApp();
    } else {
        await appAlert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.');
    }
}

function logout() {
    localStorage.removeItem(LOGGED_KEY);
    document.getElementById('login-page').style.display='block';
    document.getElementById('main-page').style.display='none';
    document.getElementById('whoami').textContent = '';
    document.getElementById('logoutBtn').style.display = 'none';
    chemicals = [];
    renderList();
}

async function initApp() {
    await refreshReagents();
    await seedDefaultDataIfNeeded();
    renderList();
    rebuildInventoryFilters?.();
    bindAutocomplete();
    bindLocationAutocomplete();
    setupHeaderNfcJump();
    setupNfcUrlPreview();
    // ìˆ«ì ì´ë¦„ë§Œ ê°€ì§„ ê¸°ì¡´ ë”ë¯¸ì˜ NFCë¥¼ ìë™ ë°±í•„ (ê°€ëŠ¥í•œ ê²½ìš°)
    ensureNfcBackfill().catch(()=>{});
    handleHashRoute();
}

window.onload = async function() {
    const loggedUser = localStorage.getItem(LOGGED_KEY);
    if(loggedUser) {
        document.getElementById('login-page').style.display='none';
        document.getElementById('main-page').style.display='block';
        document.getElementById('whoami').textContent = loggedUser;
        document.getElementById('logoutBtn').style.display = 'inline-block';
        await initApp();
    }
};

async function renderLocalDb() {
    const ul = document.getElementById('auto-db-list');
    if(!ul) return;
    ul.innerHTML = 'ë¡œë”© ì¤‘...';
    try {
        const res = await fetch(`${API_BASE}/autocomplete/local-db`);
        if(!res.ok) throw new Error('failed to load');
        const items = await res.json();
        if(!Array.isArray(items) || !items.length) {
            ul.innerHTML = '<li>í•­ëª© ì—†ìŒ</li>';
            return;
        }
        ul.innerHTML = '';
        items.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.name}  (${item.formula})  ${Array.isArray(item.synonyms)&&item.synonyms.length? 'â€” ' + item.synonyms.join('; ') : ''}`;
            const del = document.createElement('button');
            del.textContent = 'ì‚­ì œ';
            del.className = 'action-btn delete';
            del.style.marginLeft = '8px';
            del.onclick = async () => {
                const ok = await appConfirm(`${item.name}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                if(!ok) return;
                const resp = await fetch(`${API_BASE}/autocomplete/local-db/${encodeURIComponent(item.name)}`, { method: 'DELETE' });
                if(!resp.ok) { await appAlert('ì‚­ì œ ì‹¤íŒ¨'); return; }
                renderLocalDb();
            };
            li.appendChild(del);
            ul.appendChild(li);
        });
    } catch (err) {
        ul.innerHTML = '<li>ë¡œë”© ì‹¤íŒ¨</li>';
        console.error(err);
    }
}

async function addLocalAutoItem() {
    const name = document.getElementById('auto-name').value.trim();
    const formula = document.getElementById('auto-formula').value.trim();
    const synRaw = document.getElementById('auto-synonyms').value.trim();
    if(!name || !formula) { await appAlert('Nameê³¼ FormulaëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
    const synonyms = synRaw ? synRaw.split(';').map(s=>s.trim()).filter(Boolean) : [];
    const res = await fetch(`${API_BASE}/autocomplete/local-db`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, formula, synonyms })
    });
    if(res.status === 409) { await appAlert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.'); return; }
    if(!res.ok) { await appAlert('ì¶”ê°€ ì‹¤íŒ¨'); return; }
    document.getElementById('auto-name').value = '';
    document.getElementById('auto-formula').value = '';
    document.getElementById('auto-synonyms').value = '';
    renderLocalDb();
}

// ============= Scale CSV Upload Functions =============

async function uploadScaleCsvFile() {
    const fileInput = document.getElementById('csvFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        await appAlert('CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!file.name.endsWith('.csv')) {
        await appAlert('CSV íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch(`${API_BASE}/scale/upload-measurements`, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
        }
        
        const result = await response.json();
        
        // ê²°ê³¼ í‘œì‹œ
        const resultDiv = document.getElementById('csv-upload-result');
        const contentDiv = document.getElementById('csv-result-content');
        
        let html = `
            <p><strong>âœ… ${result.message}</strong></p>
            <p>ì´ ${result.results.total}ê±´ ì¤‘ ${result.results.success}ê±´ ì„±ê³µ, ${result.results.failed}ê±´ ì‹¤íŒ¨</p>
        `;
        
        if (result.results.updates.length > 0) {
            html += '<h5>ì—…ë°ì´íŠ¸ëœ ì‹œì•½:</h5><ul style="list-style:disc; padding-left:20px;">';
            result.results.updates.forEach(update => {
                const deltaSign = update.delta >= 0 ? '+' : '';
                html += `<li>
                    <strong>${escapeHtml(update.reagent_name)}</strong> (${escapeHtml(update.identifier)})<br>
                    ${update.previous_quantity.toFixed(2)}g â†’ ${update.new_quantity.toFixed(2)}g 
                    (${deltaSign}${update.delta.toFixed(2)}g)
                </li>`;
            });
            html += '</ul>';
        }
        
        if (result.results.errors.length > 0) {
            html += '<h5 style="color:#ff6b6b;">ì—ëŸ¬ ëª©ë¡:</h5><ul style="list-style:disc; padding-left:20px;">';
            result.results.errors.forEach(error => {
                html += `<li style="color:#ff6b6b;">
                    í–‰ ${error.row}: ${escapeHtml(error.error)}
                </li>`;
            });
            html += '</ul>';
        }
        
        contentDiv.innerHTML = html;
        resultDiv.style.display = 'block';
        
        // ì‹œì•½ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await refreshReagents();
        
        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        fileInput.value = '';
        
    } catch (error) {
        await appAlert(`CSV ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
        console.error(error);
    }
}

async function saveQuickMeasurement() {
    const nfcUid = document.getElementById('quick-nfc').value.trim();
    const weight = parseFloat(document.getElementById('quick-weight').value);
    const note = document.getElementById('quick-note').value.trim();
    const operator = document.getElementById('quick-operator').value.trim();
    
    if (!weight || weight < 0) {
        await appAlert('ì˜¬ë°”ë¥¸ ë¬´ê²Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (0 ì´ìƒ).');
        return;
    }
    
    if (!nfcUid) {
        await appAlert('NFC Tag UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        const params = new URLSearchParams({
            measured_weight: weight.toString()
        });
        
        if (nfcUid) params.append('nfc_tag_uid', nfcUid);
        if (note) params.append('note', note);
        if (operator) params.append('operator', operator);
        
        const response = await fetch(`${API_BASE}/scale/save-measurement?${params.toString()}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'ì €ì¥ ì‹¤íŒ¨');
        }
        
        const result = await response.json();
        
      await appAlert(`âœ… ì¸¡ì •ê°’ì´ CSV íŒŒì¼ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n` +
              `NFC: ${result.data.nfc_tag_uid}\n` +
              `ë¬´ê²Œ: ${result.data.measured_weight}g\n` +
              `ì‹œê°„: ${new Date(result.data.timestamp).toLocaleString()}\n\n` +
              `íŒŒì¼ ìœ„ì¹˜: ${result.file}`);
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('quick-nfc').value = '';
        document.getElementById('quick-weight').value = '';
        document.getElementById('quick-note').value = '';
        // operatorëŠ” ìœ ì§€
        
    } catch (error) {
        await appAlert(`ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        console.error(error);
    }
}

function downloadSampleCsv() {
    const csvContent = `nfc_tag_uid,reagent_id,reagent_name,measured_weight,timestamp,note,operator
NFC-ACE-001,1,ì•„ì„¸í†¤,485.5,2025-11-05T14:30:00,ì •ê¸°ì¸¡ì •,ê¹€ì² ìˆ˜
NFC-ETH-001,2,Ethanol,920.3,2025-11-05T14:31:00,ì‚¬ìš©í›„ì¸¡ì •,ê¹€ì² ìˆ˜
,3,Methanol,275.8,2025-11-05T14:32:00,,ì´ì˜í¬`;
    
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'scale_measurements_sample.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>
