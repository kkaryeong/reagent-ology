<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Reagent-ology</title>
<style>
    body { 
        font-family: Arial, sans-serif; 
        margin: 0; 
        padding: 0;
        background-image: url('lab.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        color: white;
    }
    header {
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 10px 20px; 
        background-color: rgba(144,178,187,0.95);
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(4px);
    }
    header h1 { margin: 0; font-size: 1.4rem; }
    #login-form input { margin-right: 5px; padding:5px; border-radius:3px; border:1px solid #ccc; }
    #login-form button { padding:5px 10px; border:none; border-radius:3px; background-color:#1b8cae; color:white; cursor:pointer; }
    #login-form button:hover { background-color:#147d99; }

    nav {
        display: flex; 
        justify-content: flex-end; 
        background-color: rgba(144,178,187,0.95); 
        padding: 8px 20px;
    }
    nav button {
        padding: 6px 12px;
        margin-left: 8px;
        background-color: transparent;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-weight: 600;
    }
    nav button:hover { background-color: rgba(0,86,179,0.2); }

    .page { display: none; margin: 20px; background-color: rgba(0,0,0,0.45); padding: 20px; border-radius: 8px; }
    #about {
        display: block;
        max-height: 700px;
        overflow-y: auto;
        padding: 20px;
        background: rgba(255, 255, 255, 0.12);
        border-radius: 10px;
    }
    #about::-webkit-scrollbar { width: 8px; }
    #about::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.18); border-radius: 4px; }
    .about-section {
        margin-bottom: 20px;
        padding: 16px;
        background: rgba(0, 0, 0, 0.35);
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        transition: transform 0.12s;
    }
    .about-section:hover { transform: translateY(-4px); }
    .about-section h3 { margin-top: 0; color: #ffffff; font-size: 1.15em; }
    .about-section p, .about-section li { line-height: 1.6; color: #ecf0f1; }
    .about-section ul { padding-left: 20px; }
    #about h2 { color: #ffffff; }

    li { 
        margin-bottom: 10px; 
        padding: 10px;
        background-color: rgba(79, 128, 147, 0.72);
        border-radius: 6px;
        list-style:none;
    }
    input, button.action-btn, select { margin-right:5px; padding:6px; border-radius:4px; border:1px solid #ccc; }
    button.action-btn { cursor:pointer; border:none; color:white; padding:6px 8px; margin-left:6px; }
    button.action-btn.edit { background-color:#ffc107; color:black; }
    button.action-btn.edit:hover { background-color:#e0a800; }
    button.action-btn.delete { background-color:#dc3545; }
    button.action-btn.delete:hover { background-color:#c82333; }
    button.action-btn.use { background-color:#28a745; }
    button.action-btn.use:hover { background-color:#218838; }
    button.action-btn.discard { background-color:#6c757d; }
    button.action-btn.discard:hover { background-color:#5a6268; }
    button.action-btn.scale { background-color:#17a2b8; }
    button.action-btn.scale:hover { background-color:#138496; }

    .controls { margin-bottom: 12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .small { padding:4px 8px; font-size:0.9rem; }

    #chemical-detail { padding: 10px; background: rgba(0,0,0,0.4); border-radius:8px; }
    .topbar-right { display:flex; gap:8px; align-items:center; }
    .danger-note { color:#ffdddd; background: rgba(220,53,69,0.12); padding:8px; border-radius:6px; margin-top:8px; }
    .meta { font-size:0.9rem; color:#e6f1f5; margin-top:8px; }
</style>
</head>
<body>
    <!-- í—¤ë” -->
    <header>
        <div id="logo"><h1>Reagent-ology</h1></div>
        <div class="topbar-right">
            <span id="whoami" style="font-weight:600;"></span>
            <button id="logoutBtn" style="display:none;" onclick="logout()" class="small">Logout</button>
        </div>
    </header>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-page" style="padding:20px;">
        <h1>Reagent-ology Login</h1>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <button onclick="signup()">Sign Up</button>
        <div class="danger-note">
            <strong>ì£¼ì˜:</strong> í˜„ì¬ëŠ” ë¡œì»¬ ë°ëª¨ ëª¨ë“œì…ë‹ˆë‹¤. ì‹¤ì œ ìš´ì˜ ì‹œ ì„œë²„ ê¸°ë°˜ ì¸ì¦(í•´ì‹œ+HTTPS)ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”.
        </div>
    </div>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <div id="main-page" style="display:none; padding:20px;">
        <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav>
            <button onclick="showPage('about')">ê¸°ì—… ì†Œê°œ</button>
            <button onclick="showPage('add')">ì‹œì•½ ë“±ë¡</button>
            <button onclick="showPage('discard')">ì‹œì•½ íê¸°</button>
            <button onclick="showPage('inventory')">ì—°êµ¬ì‹¤ ë³´ìœ  ë¬¼ì§ˆ</button>
            <button onclick="showPage('usage')">ì‹œì•½ ì‚¬ìš© í˜„í™©</button>
        </nav>

        <!-- ê° í˜ì´ì§€ ì˜ì—­ -->
        <div id="about" class="page">
            <h2>Reagent-ology ì†Œê°œ</h2>
            <div class="about-section">
                <h3>íšŒì‚¬ ë¹„ì „</h3>
                <p>ìš°ë¦¬ëŠ” ì—°êµ¬ì‹¤ì˜ ì•ˆì „í•˜ê³  íš¨ìœ¨ì ì¸ ì‹œì•½ ê´€ë¦¬ë¥¼ ìœ„í•´ ìµœì²¨ë‹¨ ë””ì§€í„¸ ì†”ë£¨ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
            </div>
            <div class="about-section">
                <h3>ì£¼ìš” ê¸°ëŠ¥</h3>
                <ul>
                    <li>ì „ ì£¼ê¸° ì‹œì•½ ê´€ë¦¬ (ë“±ë¡, ì‚¬ìš©, ì´ë™, íê¸°)</li>
                    <li>GHS ê¸°ë°˜ ë¶„ë¥˜ ë° ê²½ê³  ì‹œìŠ¤í…œ</li>
                    <li>ë²•ì  ê·œì œ ì¤€ìˆ˜ ì§€ì›</li>
                    <li>NFC ìŠ¤í‹°ì»¤ ê¸°ë°˜ ì‹œì•½ íƒœê¹…</li>
                    <li>ì‚¬ìš©ëŸ‰, íê¸°ëŸ‰, ë³´ê´€ í˜„í™© ìë™ ê¸°ë¡</li>
                </ul>
            </div>
            <div class="about-section">
                <h3>ì—°êµ¬ì‹¤ ë„ì… íš¨ê³¼</h3>
                <p>ì‚¬ìš©ìëŠ” ì§ê´€ì ì¸ ëŒ€ì‹œë³´ë“œë¡œ ì‹¤í—˜ì‹¤ ìš´ì˜ ìƒí™©ì„ í•œëˆˆì— í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©°, ì•ˆì „ ì‚¬ê³ ë¥¼ ì˜ˆë°©í•˜ê³  íš¨ìœ¨ì ì¸ ì‹œì•½ êµ¬ë§¤ ê³„íšì„ ìˆ˜ë¦½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <div id="add" class="page">
            <h2>ì‹œì•½ ë“±ë¡ / ìˆ˜ì •</h2>
            <div class="controls">
                <input type="hidden" id="edit-id">
                <input type="text" id="name" placeholder="Name">
                <input type="text" id="formula" placeholder="Formula">
                <input type="text" id="cas" placeholder="CAS ë²ˆí˜¸">
                <input type="text" id="location" placeholder="Location">
                <input type="text" id="storage" placeholder="ë³´ê´€ ì¡°ê±´">
                <input type="date" id="expiry" placeholder="ìœ í†µê¸°í•œ">
                <input type="text" id="hazard" placeholder="GHS ë¶„ë¥˜ (ì½¤ë§ˆë¡œ êµ¬ë¶„)">
                <input type="text" id="disposal" placeholder="íê¸° ë°©ë²•">
                <input type="number" step="0.01" id="quantity" placeholder="Quantity (ml/g)">
                <button onclick="saveChemical()" class="action-btn small">Save</button>
                <button onclick="resetForm()" class="small">Clear</button>
            </div>
            <div id="form-note" class="meta">í•„ìˆ˜: Name, Formula, Location, Quantity</div>
        </div>

        <div id="discard" class="page">
            <h2>ì‹œì•½ íê¸°</h2>
            <div class="controls">
                <button onclick="autoDiscardReport()" class="small">íê¸° ë¦¬í¬íŠ¸ ìƒì„± (CSV)</button>
            </div>
            <ul id="discard-list"></ul>
        </div>

        <div id="inventory" class="page">
            <h2>ì—°êµ¬ì‹¤ ë³´ìœ  ë¬¼ì§ˆ</h2>
            <div class="controls">
                <input type="text" id="search" placeholder="ê²€ìƒ‰: ì´ë¦„/ê³µì‹/CAS..." oninput="renderList()">
                <select id="filterGHS" onchange="renderList()">
                    <option value="">--GHS í•„í„°--</option>
                    <option>Flammable</option>
                    <option>Toxic</option>
                    <option>Corrosive</option>
                    <option>Oxidizer</option>
                </select>
                <select id="sortBy" onchange="renderList()">
                    <option value="id">ì •ë ¬: ë“±ë¡ìˆœ</option>
                    <option value="name">ì´ë¦„</option>
                    <option value="quantity">ìˆ˜ëŸ‰(ë‚´ë¦¼)</option>
                </select>
                <button onclick="exportCSV()" class="small">CSV ë‚´ë³´ë‚´ê¸°</button>
            </div>
            <ul id="chemical-list"></ul>
        </div>

        <div id="usage" class="page">
            <h2>ì‹œì•½ ì‚¬ìš© í˜„í™©</h2>
            <div class="controls">
                <button onclick="resetUsageStats()" class="small">ì‚¬ìš© í†µê³„ ë¦¬ì…‹</button>
            </div>
            <ul id="usage-list"></ul>
        </div>

        <!-- ìƒì„¸ í˜ì´ì§€ -->
        <div id="detail-page" class="page">
            <button onclick="showPage('inventory')" class="small">â† ë’¤ë¡œ</button>
            <div id="chemical-detail"></div>
        </div>
    </div>

<script>
/* ======================
   ë¡œì»¬ ì €ì¥ì†Œ(persistence)
   ====================== */
const STORAGE_KEY = 'reagentology_chems_v1';
const USER_KEY = 'reagentology_users_v1';
const LOGGED_KEY = 'reagentology_loggedin';

/* ì„ì‹œ ì´ˆê¸° ë°ì´í„° â€” ìµœì´ˆ ì‹¤í–‰ì‹œì—ë§Œ ì €ì¥ */
const DEFAULT_CHEMS = [
    { id: 1, name: 'Acetone', formula: 'C3H6O', cas: '67-64-1', ghs: ['Flammable'], location: 'Shelf A', storage:'RT', quantity: 500, used:0, discarded:0, expiry:'', disposal:'í™”í•™íê¸°ë¬¼' },
    { id: 2, name: 'Ethanol', formula: 'C2H6O', cas: '64-17-5', ghs: ['Flammable'], location: 'Shelf B', storage:'RT', quantity: 1000, used:0, discarded:0, expiry:'', disposal:'í™”í•™íê¸°ë¬¼' },
    { id: 3, name: 'Methanol', formula: 'CH3OH', cas: '67-56-1', ghs: ['Flammable','Toxic'], location: 'Shelf A', storage:'RT', quantity: 300, used:0, discarded:0, expiry:'', disposal:'í™”í•™íê¸°ë¬¼' },
    { id: 4, name: 'Sodium Chloride', formula: 'NaCl', cas: '7647-14-5', ghs: [], location: 'Shelf C', storage:'RT', quantity: 1000, used:0, discarded:0, expiry:'', disposal:'ì¼ë°˜íê¸°ë¬¼' },
];

let chemicals = [];
let usageLogs = []; // âœ… ì‚¬ìš©ê¸°ë¡ ì €ì¥ìš©
let suppressHashRoute = false;  // í•´ì‹œ ì´ˆê¸°í™” ì§í›„ hashchange ë¬´ì‹œ


/* ì‚¬ìš©ì ì¸ì¦ (ë¡œì»¬ ë°ëª¨) */
function signup() {
    const username = prompt("ì‚¬ìš©í•  Username ì…ë ¥:");
    const password = prompt("ì‚¬ìš©í•  Password ì…ë ¥:");
    if(!username || !password) return alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    let users = JSON.parse(localStorage.getItem(USER_KEY) || '[]');
    if(users.some(u => u.username === username)) return alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
    users.push({username, password}); // ë°ëª¨: í‰ë¬¸ ì €ì¥ (ì‹¤ì„œë¹„ìŠ¤ ê¸ˆì§€)
    localStorage.setItem(USER_KEY, JSON.stringify(users));
    alert('íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
}

function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    if(!username || !password) return alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    let users = JSON.parse(localStorage.getItem(USER_KEY) || '[]');
    const user = users.find(u => u.username===username && u.password===password);
    if(user) {
        localStorage.setItem(LOGGED_KEY, username);
        document.getElementById('login-page').style.display='none';
        document.getElementById('main-page').style.display='block';
        document.getElementById('whoami').textContent = username;
        document.getElementById('logoutBtn').style.display = 'inline-block';
        initApp();
        handleHashRoute(); // ë¡œê·¸ì¸ ì§í›„ í•´ì‹œ ì²˜ë¦¬
    } else {
        alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.');
    }
}

function logout() {
    localStorage.removeItem(LOGGED_KEY);
    document.getElementById('login-page').style.display='block';
    document.getElementById('main-page').style.display='none';
    document.getElementById('whoami').textContent = '';
    document.getElementById('logoutBtn').style.display = 'none';
}

/* ìë™ ë¡œê·¸ì¸ ìœ ì§€ */
window.onload = function() {
    const loggedUser = localStorage.getItem(LOGGED_KEY);
    if(loggedUser) {
        document.getElementById('login-page').style.display='none';
        document.getElementById('main-page').style.display='block';
        document.getElementById('whoami').textContent = loggedUser;
        document.getElementById('logoutBtn').style.display = 'inline-block';
        initApp();
    } else {
        // ìµœì´ˆ ì‹¤í–‰ ì‹œ ìƒ˜í”Œ ë°ì´í„° ë„£ê¸°
        if(!localStorage.getItem(STORAGE_KEY)) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(DEFAULT_CHEMS));
        }
    }
}

/* ì•± ì´ˆê¸°í™” */
function initApp() {
    loadFromStorage();
    renderList();
    handleHashRoute(); // í•´ì‹œ ìˆìœ¼ë©´ ìƒì„¸ë¡œ, ì—†ìœ¼ë©´ ê¸°ë³¸ í™”ë©´
}

/* ì €ì¥/ë¡œë“œ */
function loadFromStorage() {
    try {
        chemicals = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        usageLogs = JSON.parse(localStorage.getItem('usage_logs') || '[]');
        // ë³´ì •: ghsê°€ ë¬¸ìì—´ì´ë©´ ë°°ì—´ë¡œ
        chemicals.forEach(c => {
            if(typeof c.ghs === 'string') c.ghs = c.ghs ? c.ghs.split(',').map(s=>s.trim()) : [];
        });
    } catch(e) {
        chemicals = DEFAULT_CHEMS.slice();
    }
}

function saveToStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(chemicals));
    localStorage.setItem('usage_logs', JSON.stringify(usageLogs));
}

// âœ… ìŠ¬ëŸ¬ê·¸ ìƒì„± í•¨ìˆ˜ (ì‹œì•½ ì´ë¦„ + CAS + ìš©ëŸ‰ìœ¼ë¡œ URL ë³€í™˜)
function toSlug(text){
  return String(text || '')
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')  // ê³µë°±ì´ë‚˜ íŠ¹ìˆ˜ë¬¸ì â†’ í•˜ì´í”ˆ(-)
    .replace(/^-+|-+$/g, '');     // ì•ë’¤ í•˜ì´í”ˆ ì œê±°
}

/* í˜ì´ì§€ ì „í™˜ */
function showPage(pageId) {
  // í™”ë©´ ì „í™˜
  document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
  const pageEl = document.getElementById(pageId);
  if (pageEl) pageEl.style.display = 'block';

  // ğŸ”» ì—¬ê¸° ì¡°ê±´ì˜ pageIdëŠ” ì‹¤ì œ ëª©ë¡ í˜ì´ì§€ idì™€ ì •í™•íˆ ë§ì¶°ì£¼ì„¸ìš”!
  //   ì˜ˆ: 'list-page' ë˜ëŠ” 'main-page' ë“±, ë³¸ì¸ ì½”ë“œì™€ ë™ì¼í•œ ê°’
  if (pageId === 'list-page' || pageId === 'main-page') {
    suppressHashRoute = true;          // ë‹¤ìŒ hashchange ë¬´ì‹œ
    location.hash = '';                // í•´ì‹œ ì´ˆê¸°í™”
    setTimeout(() => { suppressHashRoute = false; }, 0);
  }
}

/* í¼ ë¦¬ì…‹ */
function resetForm() {
    ['edit-id','name','formula','cas','location','storage','expiry','hazard','disposal','quantity'].forEach(id=>document.getElementById(id).value='');
}

/* ì‹œì•½ ë“±ë¡/ìˆ˜ì • */
function saveChemical() {
    const id = document.getElementById('edit-id').value;
    const name = document.getElementById('name').value.trim();
    const formula = document.getElementById('formula').value.trim();
    const cas = document.getElementById('cas').value.trim();
    const location = document.getElementById('location').value.trim();
    const storage = document.getElementById('storage').value.trim();
    const expiry = document.getElementById('expiry').value;
    const hazard = document.getElementById('hazard').value.trim();
    const disposal = document.getElementById('disposal').value.trim();
    const quantityRaw = document.getElementById('quantity').value;
    const quantity = quantityRaw !== '' ? parseFloat(quantityRaw) : NaN;
    const slug = toSlug(name + '-' + cas + '-' + quantity);

    if(!name || !formula || !location || isNaN(quantity)) {
        alert('í•„ìˆ˜ í•­ëª©ì„ ì±„ì›Œì£¼ì„¸ìš”: Name, Formula, Location, Quantity');
        return;
    }

    const ghsArr = hazard ? hazard.split(',').map(s=>s.trim()).filter(Boolean) : [];

    if(id){
    // ğŸ”¹ ìˆ˜ì •ì¼ ë•Œë„ ìŠ¬ëŸ¬ê·¸ë¥¼ ìƒˆë¡œ ê³„ì‚°í•´ì„œ ì—…ë°ì´íŠ¸
    const chem = chemicals.find(c => c.id==id);
    if(chem){
        const slug = toSlug(name + '-' + cas + '-' + quantity);   // âœ… â‘  ì¶”ê°€
        Object.assign(chem, {
            name, formula, cas, location, storage, expiry,
            hazard, disposal, quantity, ghs:ghsArr,
            slug                                                  // âœ… â‘¡ í•¨ê»˜ ì €ì¥
        });
    }
} else {
    // ğŸ”¹ ìƒˆ ì‹œì•½ ë“±ë¡ì¼ ë•Œë„ ìŠ¬ëŸ¬ê·¸ë¥¼ ìƒì„±
    const newId = chemicals.length ? Math.max(...chemicals.map(c=>c.id)) + 1 : 1;
    const slug = toSlug(name + '-' + cas + '-' + quantity);       // âœ… â‘¢ ì¶”ê°€
    chemicals.push({
        id:newId,
        name, formula, cas, location, storage, expiry,
        hazard, disposal, quantity,
        used:0, discarded:0,
        ghs:ghsArr,
        slug                                                      // âœ… â‘£ í•¨ê»˜ ì €ì¥
    });
}


    saveToStorage();
    resetForm();
    renderList();
    alert('ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

/* ì €ìš¸ ì‚¬ìš© ê¸°ëŠ¥ (ì •ë°€ ì…ë ¥) */
function useWithScale(id) {
    const chem = chemicals.find(c => c.id === id);
    if (!chem) return;
    const beforeWeight = parseFloat(chem.quantity);
    const afterStr = prompt(`${chem.name}ì˜ ì €ìš¸ë¡œ ì° ë‚¨ì€ ë¬´ê²Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (í˜„ì¬: ${beforeWeight})`);
    if(afterStr === null) return; // ì·¨ì†Œ
    const afterWeight = parseFloat(afterStr);
    if (isNaN(afterWeight) || afterWeight < 0 || afterWeight > beforeWeight) {
        alert('ì˜¬ë°”ë¥¸ ë¬´ê²Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (0 â‰¤ after â‰¤ í˜„ì¬ ìˆ˜ëŸ‰).');
        return;
    }
    const usedAmount = beforeWeight - afterWeight;
    chem.used = (chem.used || 0) + usedAmount;
    chem.quantity = afterWeight;
    saveToStorage();
    renderList();
}

/* ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ + ê²€ìƒ‰/í•„í„°/ì •ë ¬ */
function renderList() {
    loadFromStorage(); // fresh
    const list = document.getElementById('chemical-list');
    const discardList = document.getElementById('discard-list');
    const usageList = document.getElementById('usage-list');
    list.innerHTML = '';
    discardList.innerHTML = '';
    usageList.innerHTML = '';

    const q = (document.getElementById('search')?.value || '').toLowerCase();
    const ghsFilter = document.getElementById('filterGHS')?.value || '';
    const sortBy = document.getElementById('sortBy')?.value || 'id';

    let filtered = chemicals.filter(c => {
        if(q){
            const text = `${c.name} ${c.formula} ${c.cas}`.toLowerCase();
            if(!text.includes(q)) return false;
        }
        if(ghsFilter){
            if(!c.ghs || !c.ghs.includes(ghsFilter)) return false;
        }
        return true;
    });

    if(sortBy === 'name') filtered.sort((a,b)=>a.name.localeCompare(b.name));
    else if(sortBy === 'quantity') filtered.sort((a,b)=> (b.quantity||0) - (a.quantity||0));
    else filtered.sort((a,b)=> (a.id||0) - (b.id||0));

    filtered.forEach(c => {
        const li = document.createElement('li');

        // ì´ë¦„(ì‹œì•½) ë§í¬ ë§Œë“¤ê¸°
        const nameLink = document.createElement('a');
        nameLink.href = `#/reagents/${c.id}`;   // ğŸ”¹ ê³ ìœ  ì£¼ì†Œ ì„¤ì •
        nameLink.textContent = c.name;
        nameLink.style.fontWeight = '700';
        nameLink.style.color = '#00bfff';
        // onclickì€ ì‚­ì œ â€” ë¼ìš°í„°ê°€ ì²˜ë¦¬í•¨
        li.appendChild(nameLink);


        const info = document.createElement('div');
        info.innerHTML = `<div style="margin-top:6px;">
            (${escapeHtml(c.formula || '')}) &nbsp; CAS: ${escapeHtml(c.cas||'N/A')} &nbsp; | &nbsp; ìœ„ì¹˜: ${escapeHtml(c.location||'N/A')}
            <br>ë³´ê´€: ${escapeHtml(c.storage||'-')} &nbsp; | &nbsp; ìœ í†µê¸°í•œ: ${escapeHtml(c.expiry||'-')} &nbsp; | &nbsp; íê¸°: ${escapeHtml(c.disposal||'-')}
            <br>Qty: <strong>${c.quantity}</strong> &nbsp; | &nbsp; GHS: 
            </div>`;
        li.appendChild(info);

        // GHS íƒœê·¸
        (c.ghs || []).forEach(tag => {
            const span = document.createElement('span');
            span.textContent = tag;
            span.style.fontWeight = '700';
            span.style.marginLeft = '8px';
            if(tag==='Flammable') span.style.color='red';
            else if(tag==='Corrosive') span.style.color='orange';
            else if(tag==='Toxic') span.style.color='purple';
            else if(tag==='Oxidizer') span.style.color='limegreen';
            li.appendChild(span);
        });

        // ë²„íŠ¼ë“¤
        const btnContainer = document.createElement('div');
        btnContainer.style.marginTop = '8px';

        const actions = [
            {cls:'edit', text:'Edit', onClick: ()=> {
                document.getElementById('edit-id').value = c.id;
                ['name','formula','cas','location','storage','expiry','hazard','disposal','quantity'].forEach(id => document.getElementById(id).value = c[id] || '');
                showPage('add');
            }},
            {cls:'delete', text:'Delete', onClick: ()=> {
                if(!confirm(`${c.name}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                chemicals = chemicals.filter(x => x.id !== c.id);
                saveToStorage(); renderList();
            }},
            {cls:'use', text:'Use -10', onClick: ()=> {
                if((c.quantity || 0) >= 10){ c.used = (c.used||0)+10; c.quantity -= 10; saveToStorage(); renderList(); } 
                else alert('ì¬ê³  ë¶€ì¡±');
            }},
            {cls:'discard', text:'Discard -10', onClick: ()=> {
                if((c.quantity || 0) >= 10){ c.discarded = (c.discarded||0)+10; c.quantity -= 10; saveToStorage(); renderList(); } 
                else alert('ì¬ê³  ë¶€ì¡±');
            }},
            {cls:'scale', text:'Use with Scale', onClick: ()=> useWithScale(c.id)}
        ];

        actions.forEach(a=>{
            const btn = document.createElement('button');
            btn.className = `action-btn ${a.cls}`;
            btn.textContent = a.text;
            btn.onclick = a.onClick;
            btnContainer.appendChild(btn);
        });

        li.appendChild(btnContainer);
        list.appendChild(li);

        // íê¸° ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        const liD = document.createElement('li');
        liD.textContent = `${c.name} - Discarded: ${c.discarded || 0}`;
        discardList.appendChild(liD);

        // ì‚¬ìš© í˜„í™© ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        const liU = document.createElement('li');
        liU.textContent = `${c.name} - Used: ${c.used || 0}`;
        usageList.appendChild(liU);
    });
}

/* =========================
   âœ… ì‚¬ìš© ê¸°ë¡ ê´€ë¦¬ í•¨ìˆ˜ë“¤
   ========================= */

// ì‚¬ìš© ê¸°ë¡ ì¶”ê°€
function addUsageLog({ reagentId, prevQty, newQty, delta, source = 'scale', note = '' }) {
  const ts = Date.now();
  const nextId = (usageLogs.length ? usageLogs[usageLogs.length - 1].id : 0) + 1;
  usageLogs.push({ id: nextId, reagentId, prevQty, newQty, delta, source, note, ts });
  saveToStorage();
}

// ì¸¡ì •ê°’ìœ¼ë¡œ Quantity ê°±ì‹  + ê¸°ë¡
function updateQuantityFromMeasurement(reagentId, measuredQty, opts = {}) {
  const { ignoreZero = true, source = 'scale', note = '' } = opts;
  const chem = chemicals.find(c => c.id == reagentId);
  if (!chem) return;

  const next = Number(measuredQty);
  if (!Number.isFinite(next)) return;
  if (ignoreZero && next === 0) return;

  const prev = Number(chem.quantity) || 0;
  if (next === prev) return;

  const newQty = Math.round(next * 100) / 100;
  const prevQty = Math.round(prev * 100) / 100;
  const delta = Math.round((newQty - prevQty) * 100) / 100;

  chem.quantity = newQty; // âœ… ì‹œì•½ ìš©ëŸ‰ ì—…ë°ì´íŠ¸
  addUsageLog({ reagentId, prevQty, newQty, delta, source, note }); // âœ… ê¸°ë¡ ë‚¨ê¸°ê¸°
  saveToStorage();
  renderList?.();

  // ìƒì„¸ í˜ì´ì§€ê°€ ì—´ë ¤ ìˆë‹¤ë©´ ì¬ë Œë”
  if (typeof renderUsageLogList === 'function') renderUsageLogList(reagentId);
  if (typeof showChemicalDetail === 'function') {
    const openId = document.getElementById('detail-page')?.style.display === 'block' ? reagentId : null;
    if (openId) showChemicalDetail(reagentId);
  }
}

function renderUsageLogList(reagentId) {
  const box = document.getElementById('usage-log');
  if (!box) return;

  const logs = usageLogs
    .filter(l => l.reagentId == reagentId)
    .sort((a, b) => b.ts - a.ts);

  if (!logs.length) {
    box.innerHTML = '<li>ê¸°ë¡ ì—†ìŒ</li>';
    return;
  }

  box.innerHTML = logs.map(l => {
    const when = new Date(l.ts).toLocaleString();
    const sign = l.delta > 0 ? '+' : '';
    return `<li>
      <span>${when}</span>
      &nbsp; <strong>${sign}${l.delta}</strong> â†’ ${l.newQty}
      &nbsp; <em style="opacity:.7">${l.source || ''}</em>
      ${l.note ? `&nbsp; <span>${l.note}</span>` : ''}
    </li>`;
  }).join('');
}

/* ìƒì„¸ ë³´ê¸° */
function showChemicalDetail(id) {
  const chem = chemicals.find(c => c.id == id);
  if (!chem) { alert('ì‹œì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

  const detailDiv = document.getElementById('chemical-detail');

  // ê¸°ë³¸ ì •ë³´
  detailDiv.innerHTML = `
    <h2 style="margin-bottom:6px">${escapeHtml(chem.name)}</h2>
    <div class="meta" style="opacity:.8;margin-bottom:10px">
      ID: ${chem.id}${chem.slug ? ` &nbsp;|&nbsp; slug: ${escapeHtml(chem.slug)}` : ''}
    </div>

    <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:start">
      <div>
        <p><strong>Quantity</strong>: <span id="chem-qty">${chem.quantity ?? 0}</span></p>
        <p><strong>CAS</strong>: ${escapeHtml(chem.cas || '-')}</p>
        <p><strong>Formula</strong>: ${escapeHtml(chem.formula || '-')}</p>
        <p><strong>Location</strong>: ${escapeHtml(chem.location || '-')}</p>
        <p><strong>Storage</strong>: ${escapeHtml(chem.storage || '-')}</p>
        <p><strong>Expiry</strong>: ${escapeHtml(chem.expiry || '-')}</p>
      </div>
      <div>
        <p><strong>Hazard</strong>: ${escapeHtml(chem.hazard || '-')}</p>
        <p><strong>Disposal</strong>: ${escapeHtml(chem.disposal || '-')}</p>
        <p><strong>Used</strong>: ${chem.used ?? 0}</p>
        <p><strong>Discarded</strong>: ${chem.discarded ?? 0}</p>
        <p><strong>GHS</strong>: ${
          Array.isArray(chem.ghs) && chem.ghs.length ? chem.ghs.map(g=>`<span class="tag">${escapeHtml(g)}</span>`).join(' ') : '-'
        }</p>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:6px;flex-wrap:wrap">
      <button class="small" onclick="promptManualQuantity(${chem.id})">ìˆ˜ë™ ë³€ê²½</button>
      <button class="small" onclick="showPage('list-page'); location.hash=''">ëª©ë¡ìœ¼ë¡œ</button>
      <button class="small" onclick="copyReagentLink(${chem.id})">ë§í¬ ë³µì‚¬</button>
    </div>
  `;

  // ì‚¬ìš© ê¸°ë¡ ì˜ì—­ ì¶”ê°€
  detailDiv.innerHTML += `
    <h3 style="margin-top:16px">ì‚¬ìš© ê¸°ë¡</h3>
    <ul id="usage-log" style="margin:0;padding-left:18px"></ul>
  `;

  // ê¸°ë¡ ë Œë”ë§
  if (typeof renderUsageLogList === 'function') renderUsageLogList(id);

  showPage('detail-page');
}

async function copyReagentLink(id){
    const url = `${location.origin}${location.pathname}#/reagents/${id}`;
    try { await navigator.clipboard.writeText(url); alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'); }
    catch { prompt('ë³µì‚¬ ì‹¤íŒ¨. ì•„ë˜ ë§í¬ë¥¼ ìˆ˜ë™ ë³µì‚¬í•˜ì„¸ìš”:', url); }
}

/* ë””í…Œì¼ì—ì„œ í¸ì§‘ ì—´ê¸° */
function openEditFromDetail(id) {
    const chem = chemicals.find(c=>c.id===id);
    if(!chem) return;
    ['edit-id','name','formula','cas','location','storage','expiry','hazard','disposal','quantity'].forEach(k=>{
        document.getElementById(k).value = chem[k] || '';
    });
    showPage('add');
}

/* ë””í…Œì¼ì—ì„œ ì‚­ì œ */
function promptDelete(id) {
    if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    chemicals = chemicals.filter(c=>c.id!==id);
    saveToStorage();
    renderList();
    showPage('inventory');
}

/* ê°„ë‹¨ ì´ë™ ê¸°ë¡(ì˜ˆì‹œ) */
function startTransfer(id) {
    const chem = chemicals.find(c=>c.id===id);
    if(!chem) return;
    const newLoc = prompt(`${chem.name}ì˜ ìƒˆ ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í˜„ì¬: ${chem.location})`);
    if(newLoc === null) return;
    chem.location = newLoc.trim() || chem.location;
    saveToStorage(); renderList();
    alert('ì´ë™ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

/* CSV ë‚´ë³´ë‚´ê¸° */
function exportCSV() {
    loadFromStorage();
    if(!chemicals.length) return alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    const rows = [['id','name','formula','cas','location','storage','expiry','quantity','ghs','used','discarded','disposal']];
    chemicals.forEach(c => {
        rows.push([
            c.id, c.name, c.formula, c.cas, c.location, c.storage, c.expiry || '', c.quantity, (c.ghs || []).join(';'), c.used || 0, c.discarded || 0, c.disposal || ''
        ]);
    });
    const csv = rows.map(r => r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `reagentology_export_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
}

/* íê¸° ë¦¬í¬íŠ¸ CSV (ë‹¨ìˆœ ì˜ˆì‹œ) */
function autoDiscardReport(){
    loadFromStorage();
    const rows = [['name','discarded']];
    chemicals.forEach(c=>{
        rows.push([c.name, c.discarded || 0]);
    });
    const csv = rows.map(r => r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `discard_report_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
}

/* ì‚¬ìš© í†µê³„ ë¦¬ì…‹ (ë°ëª¨) */
function resetUsageStats(){
    if(!confirm('ëª¨ë“  ì‚¬ìš©/íê¸° í†µê³„ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    chemicals.forEach(c=>{ c.used = 0; c.discarded = 0; });
    saveToStorage();
    renderList();
}

/* í—¬í¼: CSV/HTML ì´ìŠ¤ì¼€ì´í”„ */
function escapeHtml(str) {
    if(str === undefined || str === null) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

/* ì‘ì€ ìœ í‹¸: ì‚­ì œ ë“±ì—ì„œ ì‚¬ìš© */
function promptDeleteByName(name){
    return confirm(`${name}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
}

/* í˜ì´ì§€ ì „í™˜ ì‹œ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë³´ì¥ */
document.querySelectorAll('nav button').forEach(btn => btn.addEventListener('click', ()=> {
    setTimeout(renderList, 120);
}));

// ===== Hash Router =====
function parseHash() {
  // ì˜ˆ: "#/reagents/12" â†’ { route: "reagents", param: "12" }
  const h = (location.hash || '').replace(/^#\/?/, ''); // "reagents/12"
  const [route, param] = h.split('/');
  return { route: route || '', param: param || '' };
}

function handleHashRoute() {
  const { route, param } = parseHash();

  // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸: ë¯¸ë¡œê·¸ì¸ì´ë¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ ìœ ì§€
  const loggedUser = localStorage.getItem('reagentology_loggedin');
  if (!loggedUser) {
    // ë¡œê·¸ì¸ í›„ initApp()ì´ í˜¸ì¶œë˜ë©´, ë‹¤ì‹œ handleHashRouteë¥¼ ë¶ˆëŸ¬ ìƒì„¸ë¡œ ì§„ì…í•¨
    showPage('login-page'); 
    return;
  }

  if (route === 'reagents' && param) {
  // ë¨¼ì € slugë¡œ ì°¾ê³ , ì—†ìœ¼ë©´ ìˆ«ì idë¡œ ì°¾ê¸°
  let chem = chemicals.find(c => c.slug === param);
  if (!chem) {
    const idNum = Number(param);
    if (!Number.isNaN(idNum)) chem = chemicals.find(c => c.id === idNum);
  }
  if (chem) {
    showChemicalDetail(chem.id);
    return;
  }
}

  // ê¸°ë³¸ ì§„ì… í™”ë©´(ì›ë˜ aboutë¡œ ê°€ë˜ íë¦„ ìœ ì§€)
  showPage('about');
}

// í•´ì‹œ ë³€ê²½ ì‹œ ë¼ìš°íŒ…
window.addEventListener('hashchange', () => {
  if (suppressHashRoute) return;   // ì´ˆê¸°í™” ì§í›„ ë°œìƒí•œ hashchangeëŠ” ë¬´ì‹œ
  handleHashRoute();
});

// ì•± ì´ˆê¸°í™”(initApp) ì´í›„ì—ë„ í•´ì‹œë¥¼ ì‚´í´ì„œ ë°”ë¡œ ìƒì„¸ë¡œ ë“¤ì–´ê°€ë„ë¡ ì½œ
function initApp() {
  loadFromStorage();
  renderList();
  // í•´ì‹œê°€ ìˆìœ¼ë©´ ìƒì„¸ë¡œ, ì—†ìœ¼ë©´ ê¸°ì¡´ì²˜ëŸ¼ about
  handleHashRoute();
}
</script>


</script>
</body>
</html>
